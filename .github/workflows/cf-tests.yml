##
# CF-WC-029: CI test configuration
# Tests in CI pipeline with commands, env vars, parallel execution, and reports
# Content Factory Test Suite
##

name: Content Factory Tests

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'backend/**'
      - 'packages/**'
      - 'docs/feature_list_content_factory.json'
      - '.github/workflows/cf-tests.yml'
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  CI: true

jobs:
  # ============================================
  # Unit Tests - Content Factory
  # ============================================
  cf-unit-tests:
    name: CF Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]

    env:
      DATABASE_URL: postgresql://test:test@localhost:5432/cf_test
      NODE_ENV: test
      JWT_SECRET: test-jwt-secret-key
      ANTHROPIC_API_KEY: test-api-key

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: cf_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci

      - name: Generate Prisma Client
        working-directory: backend
        run: npx prisma generate

      - name: Run database migrations
        working-directory: backend
        run: npx prisma migrate deploy

      - name: Seed test data
        working-directory: backend
        run: npm run db:seed

      - name: Run CF unit tests (shard ${{ matrix.shard }}/4)
        working-directory: backend
        run: |
          npm run test -- --shard=${{ matrix.shard }}/4 --reporter=json --reporter=html --outputFile=test-results-${{ matrix.shard }}.json
        env:
          VITEST_SHARD: ${{ matrix.shard }}/4

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cf-unit-test-results-shard-${{ matrix.shard }}
          path: |
            backend/test-results/
            backend/test-results-${{ matrix.shard }}.json
          retention-days: 30

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cf-coverage-shard-${{ matrix.shard }}
          path: backend/coverage/
          retention-days: 30

  # ============================================
  # Integration Tests - Content Factory
  # ============================================
  cf-integration-tests:
    name: CF Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: cf-unit-tests

    env:
      DATABASE_URL: postgresql://test:test@localhost:5432/cf_test
      NODE_ENV: test
      JWT_SECRET: test-jwt-secret-key
      ANTHROPIC_API_KEY: test-api-key
      REMOTION_API_URL: https://api.remotion.dev
      TIKTOK_CLIENT_KEY: test-tiktok-client
      TIKTOK_CLIENT_SECRET: test-tiktok-secret

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: cf_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci

      - name: Generate Prisma Client
        working-directory: backend
        run: npx prisma generate

      - name: Run database migrations
        working-directory: backend
        run: npx prisma migrate deploy

      - name: Seed test data
        working-directory: backend
        run: npm run db:seed

      - name: Run CF integration tests
        working-directory: backend
        run: |
          npm run test -- --run cf-*.test.ts --reporter=json --reporter=html --outputFile=integration-results.json

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cf-integration-test-results
          path: |
            backend/test-results/
            backend/integration-results.json
          retention-days: 30

  # ============================================
  # Security & Compliance Tests
  # ============================================
  cf-security-tests:
    name: CF Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      DATABASE_URL: postgresql://test:test@localhost:5432/cf_test
      NODE_ENV: test

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: cf_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci

      - name: Generate Prisma Client
        working-directory: backend
        run: npx prisma generate

      - name: Run security tests
        working-directory: backend
        run: |
          npm run test -- security*.test.ts --reporter=json --outputFile=security-results.json

      - name: Upload security test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cf-security-test-results
          path: backend/security-results.json
          retention-days: 90

  # ============================================
  # Coverage Report
  # ============================================
  cf-coverage-report:
    name: CF Coverage Report
    runs-on: ubuntu-latest
    needs: [cf-unit-tests, cf-integration-tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: cf-coverage-*
          path: coverage-shards

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Merge coverage reports
        working-directory: backend
        run: |
          npx nyc merge ../coverage-shards coverage/coverage-final.json
          npx nyc report --reporter=html --reporter=text --reporter=json-summary

      - name: Upload merged coverage
        uses: actions/upload-artifact@v4
        with:
          name: cf-merged-coverage
          path: backend/coverage/
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('backend/coverage/coverage-summary.json', 'utf8'));
            const total = coverage.total;

            const comment = `## Content Factory Test Coverage

            | Metric | Coverage |
            |--------|----------|
            | Lines | ${total.lines.pct}% |
            | Statements | ${total.statements.pct}% |
            | Functions | ${total.functions.pct}% |
            | Branches | ${total.branches.pct}% |
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================
  # Test Summary Report
  # ============================================
  cf-test-summary:
    name: CF Test Summary
    runs-on: ubuntu-latest
    needs: [cf-unit-tests, cf-integration-tests, cf-security-tests]
    if: always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: cf-*-test-results*
          path: all-test-results

      - name: Generate summary
        run: |
          echo "## Content Factory Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Execution" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: ✅ Completed" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: ✅ Completed" >> $GITHUB_STEP_SUMMARY
          echo "- Security Tests: ✅ Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All test artifacts have been uploaded for review." >> $GITHUB_STEP_SUMMARY

      - name: Upload combined results
        uses: actions/upload-artifact@v4
        with:
          name: cf-all-test-results
          path: all-test-results/
          retention-days: 30
