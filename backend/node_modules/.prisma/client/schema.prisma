generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name       String    @db.VarChar(255)
  slug       String    @unique @db.VarChar(100)
  plan       String?   @default("free") @db.VarChar(50)
  settings   Json?     @default("{}")
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)

  @@map("organizations")
}

model User {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email        String    @unique @db.VarChar(255)
  name         String    @db.VarChar(255)
  passwordHash String?   @map("password_hash") @db.VarChar(255)
  avatarUrl    String?   @map("avatar_url") @db.VarChar(500)
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  updated_at   DateTime? @default(now()) @db.Timestamptz(6)

  @@map("users")
}

model Membership {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  orgId      String    @map("org_id") @db.Uuid
  role       String    @default("member") @db.VarChar(50)
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([userId, orgId])
  @@map("memberships")
}

model ApiToken {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  name       String
  tokenHash  String    @map("token_hash")
  scopes     Json      @default("[]")
  lastUsedAt DateTime? @map("last_used_at")
  expiresAt  DateTime? @map("expires_at")
  createdAt  DateTime  @default(now())

  @@map("api_tokens")
}

model Project {
  id               String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orgId            String?        @map("org_id") @db.Uuid
  name             String         @db.VarChar(255)
  description      String?
  status           ProjectStatus? @default(draft)
  appSpecVersionId String?        @map("app_spec_version_id") @db.Uuid
  touchLevel       String?        @default("medium") @map("touch_level") @db.VarChar(20)
  profitPotential  String?        @default("medium") @map("profit_potential") @db.VarChar(20)
  difficulty       String?        @default("medium") @db.VarChar(20)
  automationMode   String?        @default("hybrid") @map("automation_mode") @db.VarChar(50)
  iconUrl          String?        @map("icon_url") @db.VarChar(500)
  color            String?        @default("#3B82F6") @db.VarChar(20)
  nextAction       String?        @map("next_action")
  createdBy        String?        @map("created_by") @db.Uuid
  created_at       DateTime?      @default(now()) @db.Timestamptz(6)
  updated_at       DateTime?      @default(now()) @db.Timestamptz(6)

  @@index([orgId], map: "idx_projects_org")
  @@index([status], map: "idx_projects_status")
  @@map("projects")
}

model ProjectSpec {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId  String    @map("project_id") @db.Uuid
  version    Int       @default(1)
  content    String
  createdBy  String?   @map("created_by") @db.Uuid
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([projectId, version])
  @@map("project_specs")
}

model Repo {
  id                   String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId            String          @map("project_id") @db.Uuid
  provider             GitProviderType @default(github)
  repoUrl              String          @map("repo_url") @db.VarChar(500)
  defaultBranch        String?         @default("main") @map("default_branch") @db.VarChar(100)
  installationId       String?         @map("installation_id") @db.VarChar(255)
  accessTokenEncrypted String?         @map("access_token_encrypted")
  workspacePath        String?         @map("workspace_path") @db.VarChar(500)
  created_at           DateTime?       @default(now()) @db.Timestamptz(6)
  updated_at           DateTime?       @default(now()) @db.Timestamptz(6)

  @@map("repos")
}

model Feature {
  id                 String        @id @default(uuid())
  projectId          String        @map("project_id")
  featureKey         String        @map("feature_key")
  title              String
  description        String?
  acceptanceCriteria Json          @default("[]") @map("acceptance_criteria")
  priority           Int           @default(50)
  status             FeatureStatus @default(pending)
  source             String        @default("feature_list")
  testPlan           Json?         @map("test_plan")
  nonfunctional      Json?
  sessionCompleted   Int?          @map("session_completed")
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@unique([projectId, featureKey])
  @@index([projectId], map: "idx_features_project")
  @@index([status], map: "idx_features_status")
  @@map("features")
}

model WorkItem {
  id              String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId       String          @map("project_id") @db.Uuid
  type            WorkItemType    @default(task)
  status          WorkItemStatus? @default(idea)
  title           String          @db.VarChar(255)
  description     String?
  assigneeUserId  String?         @map("assignee_user_id") @db.Uuid
  assigneeAgentId String?         @map("assignee_agent_id") @db.Uuid
  featureId       String?         @map("feature_id") @db.Uuid
  parentId        String?         @map("parent_id") @db.Uuid
  priority        Int?            @default(50)
  storyPoints     Int?            @map("story_points")
  sprintId        String?         @map("sprint_id") @db.Uuid
  createdBy       String?         @map("created_by") @db.Uuid
  created_at      DateTime?       @default(now()) @db.Timestamptz(6)
  updated_at      DateTime?       @default(now()) @db.Timestamptz(6)

  @@index([assigneeUserId], map: "idx_work_items_assignee")
  @@index([projectId], map: "idx_work_items_project")
  @@index([status], map: "idx_work_items_status")
  @@map("work_items")
}

model WorkItemLink {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sourceId   String    @map("source_id") @db.Uuid
  targetId   String    @map("target_id") @db.Uuid
  linkType   LinkType  @map("link_type")
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([sourceId, targetId, linkType])
  @@map("work_item_links")
}

model TestCase {
  id          String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId   String       @map("project_id") @db.Uuid
  featureId   String?      @map("feature_id") @db.Uuid
  codePath    String?      @map("code_path") @db.VarChar(500)
  name        String       @db.VarChar(255)
  description String?
  type        TestCaseType @default(unit)
  tool        String?      @db.VarChar(50)
  isRequired  Boolean?     @default(true) @map("is_required")
  status      String?      @default("pending") @db.VarChar(50)
  created_at  DateTime?    @default(now()) @db.Timestamptz(6)
  updated_at  DateTime?    @default(now()) @db.Timestamptz(6)

  @@map("test_cases")
}

model TestRun {
  id           String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId    String         @map("project_id") @db.Uuid
  commitSha    String?        @map("commit_sha") @db.VarChar(40)
  branch       String?        @db.VarChar(100)
  triggeredBy  String         @map("triggered_by") @db.VarChar(50)
  agentRunId   String?        @map("agent_run_id") @db.Uuid
  status       TestRunStatus? @default(pending)
  totalTests   Int?           @default(0) @map("total_tests")
  passedTests  Int?           @default(0) @map("passed_tests")
  failedTests  Int?           @default(0) @map("failed_tests")
  skippedTests Int?           @default(0) @map("skipped_tests")
  startedAt    DateTime?      @map("started_at") @db.Timestamptz(6)
  finishedAt   DateTime?      @map("finished_at") @db.Timestamptz(6)
  created_at   DateTime?      @default(now()) @db.Timestamptz(6)

  @@index([projectId], map: "idx_test_runs_project")
  @@index([status], map: "idx_test_runs_status")
  @@map("test_runs")
}

model TestRunResult {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  testRunId   String    @map("test_run_id") @db.Uuid
  testCaseId  String?   @map("test_case_id") @db.Uuid
  testName    String?   @map("test_name") @db.VarChar(255)
  status      String    @db.VarChar(50)
  durationMs  Int?      @map("duration_ms")
  errorOutput String?   @map("error_output")
  stackTrace  String?   @map("stack_trace")
  created_at  DateTime? @default(now()) @db.Timestamptz(6)

  @@map("test_run_results")
}

model Agent {
  id         String    @id @default(uuid())
  projectId  String    @map("project_id")
  type       AgentType
  name       String
  status     String    @default("enabled")
  configJson Json      @default("{}") @map("config_json")
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@map("agents")
}

model AgentRun {
  id                String         @id @default(uuid())
  agentId           String         @map("agent_id")
  projectId         String         @map("project_id")
  runType           String         @map("run_type")
  sessionNumber     Int            @default(1) @map("session_number")
  targetFeatureId   String?        @map("target_feature_id")
  status            AgentRunStatus @default(queued)
  model             String         @default("claude-sonnet-4-5-20250929")
  inputSnapshotRef  String?        @map("input_snapshot_ref")
  outputSnapshotRef String?        @map("output_snapshot_ref")
  featuresCompleted Int            @default(0) @map("features_completed")
  commitsMade       Int            @default(0) @map("commits_made")
  tokensUsed        Int            @default(0) @map("tokens_used")
  errorMessage      String?        @map("error_message")
  startedAt         DateTime?      @map("started_at")
  finishedAt        DateTime?      @map("finished_at")
  createdAt         DateTime       @default(now())

  @@index([projectId], map: "idx_agent_runs_project")
  @@index([status], map: "idx_agent_runs_status")
  @@map("agent_runs")
}

model AgentRunEvent {
  id          String         @id @default(uuid())
  agentRunId  String         @map("agent_run_id")
  step        Int
  eventType   AgentEventType @map("event_type")
  payloadJson Json           @map("payload_json")
  createdAt   DateTime       @default(now())

  @@index([agentRunId], map: "idx_agent_run_events_run")
  @@map("agent_run_events")
}

model GitProvider {
  id                  String          @id @default(uuid())
  orgId               String          @map("org_id")
  type                GitProviderType
  name                String
  apiBaseUrl          String?         @map("api_base_url")
  appId               String?         @map("app_id")
  privateKeyEncrypted String?         @map("private_key_encrypted")
  createdAt           DateTime        @default(now())

  @@map("git_providers")
}

model GitInstallation {
  id                     String   @id @default(uuid())
  providerId             String   @map("provider_id")
  orgId                  String   @map("org_id")
  externalInstallationId String   @map("external_installation_id")
  accountName            String?  @map("account_name")
  accountType            String?  @map("account_type")
  permissions            Json?
  createdAt              DateTime @default(now())

  @@map("git_installations")
}

model Commit {
  id               String           @id @default(uuid())
  projectId        String           @map("project_id")
  repoId           String?          @map("repo_id")
  sha              String
  branch           String
  message          String
  authorType       CommitAuthorType @map("author_type")
  authorUserId     String?          @map("author_user_id")
  authorAgentRunId String?          @map("author_agent_run_id")
  filesChanged     Int?             @map("files_changed")
  additions        Int?
  deletions        Int?
  createdAt        DateTime         @default(now())

  @@index([projectId], map: "idx_commits_project")
  @@map("commits")
}

model Notification {
  id           String               @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId       String               @map("user_id") @db.Uuid
  orgId        String?              @map("org_id") @db.Uuid
  projectId    String?              @map("project_id") @db.Uuid
  channel      NotificationChannel? @default(in_app)
  type         String               @db.VarChar(100)
  title        String               @db.VarChar(255)
  body         String?
  data         Json?
  readAt       DateTime?            @map("read_at") @db.Timestamptz(6)
  snoozedUntil DateTime?            @map("snoozed_until") @db.Timestamptz(6)
  created_at   DateTime?            @default(now()) @db.Timestamptz(6)

  @@index([userId], map: "idx_notifications_user")
  @@map("notifications")
}

enum ProjectStatus {
  draft
  active
  paused
  archived
  complete

  @@map("project_status")
}

enum GitProviderType {
  github
  gitlab
  bitbucket
  local

  @@map("git_provider")
}

enum FeatureStatus {
  pending
  in_progress
  passing
  failing
  blocked

  @@map("feature_status")
}

enum WorkItemType {
  epic
  story
  task
  bug
  subtask

  @@map("work_item_type")
}

enum WorkItemStatus {
  idea
  ready
  in_progress
  in_review
  done
  released
  blocked

  @@map("work_item_status")
}

enum LinkType {
  blocks
  is_blocked_by
  relates_to
  tests
  duplicates

  @@map("link_type")
}

enum TestCaseType {
  unit
  integration
  e2e
  regression
  smoke
  performance
  accessibility

  @@map("test_case_type")
}

enum TestRunStatus {
  pending
  running
  passed
  failed
  cancelled

  @@map("test_run_status")
}

enum AgentType {
  initializer
  coding
  planner
  qa
  release
  analytics

  @@map("agent_type")
}

enum AgentRunStatus {
  queued
  running
  completed
  failed
  cancelled

  @@map("agent_run_status")
}

enum AgentEventType {
  tool_call
  tool_result
  message
  test_run
  commit
  error
  status_change

  @@map("agent_event_type")
}

enum CommitAuthorType {
  user
  agent

  @@map("commit_author_type")
}

enum NotificationChannel {
  in_app
  email
  slack
  webhook

  @@map("notification_channel")
}
