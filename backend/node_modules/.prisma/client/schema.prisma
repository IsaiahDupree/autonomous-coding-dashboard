generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name       String    @db.VarChar(255)
  slug       String    @unique @db.VarChar(100)
  plan       String?   @default("free") @db.VarChar(50)
  settings   Json?     @default("{}")
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)

  @@map("organizations")
}

model User {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  email        String    @unique @db.VarChar(255)
  name         String    @db.VarChar(255)
  passwordHash String?   @map("password_hash") @db.VarChar(255)
  avatarUrl    String?   @map("avatar_url") @db.VarChar(500)
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  updated_at   DateTime? @default(now()) @db.Timestamptz(6)

  @@map("users")
}

model Membership {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId     String    @map("user_id") @db.Uuid
  orgId      String    @map("org_id") @db.Uuid
  role       String    @default("member") @db.VarChar(50)
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([userId, orgId])
  @@map("memberships")
}

model ApiToken {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  name       String
  tokenHash  String    @map("token_hash")
  scopes     Json      @default("[]")
  lastUsedAt DateTime? @map("last_used_at")
  expiresAt  DateTime? @map("expires_at")
  createdAt  DateTime  @default(now())

  @@map("api_tokens")
}

model Project {
  id               String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  orgId            String?        @map("org_id") @db.Uuid
  name             String         @db.VarChar(255)
  description      String?
  status           ProjectStatus? @default(draft)
  appSpecVersionId String?        @map("app_spec_version_id") @db.Uuid
  touchLevel       String?        @default("medium") @map("touch_level") @db.VarChar(20)
  profitPotential  String?        @default("medium") @map("profit_potential") @db.VarChar(20)
  difficulty       String?        @default("medium") @db.VarChar(20)
  automationMode   String?        @default("hybrid") @map("automation_mode") @db.VarChar(50)
  iconUrl          String?        @map("icon_url") @db.VarChar(500)
  color            String?        @default("#3B82F6") @db.VarChar(20)
  nextAction       String?        @map("next_action")
  createdBy        String?        @map("created_by") @db.Uuid
  created_at       DateTime?      @default(now()) @db.Timestamptz(6)
  updated_at       DateTime?      @default(now()) @db.Timestamptz(6)

  @@index([orgId], map: "idx_projects_org")
  @@index([status], map: "idx_projects_status")
  @@map("projects")
}

model ProjectSpec {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId  String    @map("project_id") @db.Uuid
  version    Int       @default(1)
  content    String
  createdBy  String?   @map("created_by") @db.Uuid
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([projectId, version])
  @@map("project_specs")
}

model Repo {
  id                   String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId            String          @map("project_id") @db.Uuid
  provider             GitProviderType @default(github)
  repoUrl              String          @map("repo_url") @db.VarChar(500)
  defaultBranch        String?         @default("main") @map("default_branch") @db.VarChar(100)
  installationId       String?         @map("installation_id") @db.VarChar(255)
  accessTokenEncrypted String?         @map("access_token_encrypted")
  workspacePath        String?         @map("workspace_path") @db.VarChar(500)
  created_at           DateTime?       @default(now()) @db.Timestamptz(6)
  updated_at           DateTime?       @default(now()) @db.Timestamptz(6)

  @@map("repos")
}

model Feature {
  id                 String        @id @default(uuid())
  projectId          String        @map("project_id")
  featureKey         String        @map("feature_key")
  title              String
  description        String?
  acceptanceCriteria Json          @default("[]") @map("acceptance_criteria")
  priority           Int           @default(50)
  status             FeatureStatus @default(pending)
  source             String        @default("feature_list")
  testPlan           Json?         @map("test_plan")
  nonfunctional      Json?
  sessionCompleted   Int?          @map("session_completed")
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@unique([projectId, featureKey])
  @@index([projectId], map: "idx_features_project")
  @@index([status], map: "idx_features_status")
  @@map("features")
}

model WorkItem {
  id              String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId       String          @map("project_id") @db.Uuid
  type            WorkItemType    @default(task)
  status          WorkItemStatus? @default(idea)
  title           String          @db.VarChar(255)
  description     String?
  assigneeUserId  String?         @map("assignee_user_id") @db.Uuid
  assigneeAgentId String?         @map("assignee_agent_id") @db.Uuid
  featureId       String?         @map("feature_id") @db.Uuid
  parentId        String?         @map("parent_id") @db.Uuid
  priority        Int?            @default(50)
  storyPoints     Int?            @map("story_points")
  sprintId        String?         @map("sprint_id") @db.Uuid
  createdBy       String?         @map("created_by") @db.Uuid
  created_at      DateTime?       @default(now()) @db.Timestamptz(6)
  updated_at      DateTime?       @default(now()) @db.Timestamptz(6)

  @@index([assigneeUserId], map: "idx_work_items_assignee")
  @@index([projectId], map: "idx_work_items_project")
  @@index([status], map: "idx_work_items_status")
  @@map("work_items")
}

model WorkItemLink {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  sourceId   String    @map("source_id") @db.Uuid
  targetId   String    @map("target_id") @db.Uuid
  linkType   LinkType  @map("link_type")
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@unique([sourceId, targetId, linkType])
  @@map("work_item_links")
}

model TestCase {
  id          String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId   String       @map("project_id") @db.Uuid
  featureId   String?      @map("feature_id") @db.Uuid
  codePath    String?      @map("code_path") @db.VarChar(500)
  name        String       @db.VarChar(255)
  description String?
  type        TestCaseType @default(unit)
  tool        String?      @db.VarChar(50)
  isRequired  Boolean?     @default(true) @map("is_required")
  status      String?      @default("pending") @db.VarChar(50)
  created_at  DateTime?    @default(now()) @db.Timestamptz(6)
  updated_at  DateTime?    @default(now()) @db.Timestamptz(6)

  @@map("test_cases")
}

model TestRun {
  id           String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  projectId    String         @map("project_id") @db.Uuid
  commitSha    String?        @map("commit_sha") @db.VarChar(40)
  branch       String?        @db.VarChar(100)
  triggeredBy  String         @map("triggered_by") @db.VarChar(50)
  agentRunId   String?        @map("agent_run_id") @db.Uuid
  status       TestRunStatus? @default(pending)
  totalTests   Int?           @default(0) @map("total_tests")
  passedTests  Int?           @default(0) @map("passed_tests")
  failedTests  Int?           @default(0) @map("failed_tests")
  skippedTests Int?           @default(0) @map("skipped_tests")
  startedAt    DateTime?      @map("started_at") @db.Timestamptz(6)
  finishedAt   DateTime?      @map("finished_at") @db.Timestamptz(6)
  created_at   DateTime?      @default(now()) @db.Timestamptz(6)

  @@index([projectId], map: "idx_test_runs_project")
  @@index([status], map: "idx_test_runs_status")
  @@map("test_runs")
}

model TestRunResult {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  testRunId   String    @map("test_run_id") @db.Uuid
  testCaseId  String?   @map("test_case_id") @db.Uuid
  testName    String?   @map("test_name") @db.VarChar(255)
  status      String    @db.VarChar(50)
  durationMs  Int?      @map("duration_ms")
  errorOutput String?   @map("error_output")
  stackTrace  String?   @map("stack_trace")
  created_at  DateTime? @default(now()) @db.Timestamptz(6)

  @@map("test_run_results")
}

model Agent {
  id         String    @id @default(uuid())
  projectId  String    @map("project_id")
  type       AgentType
  name       String
  status     String    @default("enabled")
  configJson Json      @default("{}") @map("config_json")
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@map("agents")
}

model AgentRun {
  id                String         @id @default(uuid())
  agentId           String         @map("agent_id")
  projectId         String         @map("project_id")
  runType           String         @map("run_type")
  sessionNumber     Int            @default(1) @map("session_number")
  targetFeatureId   String?        @map("target_feature_id")
  status            AgentRunStatus @default(queued)
  model             String         @default("claude-sonnet-4-5-20250929")
  inputSnapshotRef  String?        @map("input_snapshot_ref")
  outputSnapshotRef String?        @map("output_snapshot_ref")
  featuresCompleted Int            @default(0) @map("features_completed")
  commitsMade       Int            @default(0) @map("commits_made")
  tokensUsed        Int            @default(0) @map("tokens_used")
  errorMessage      String?        @map("error_message")
  startedAt         DateTime?      @map("started_at")
  finishedAt        DateTime?      @map("finished_at")
  createdAt         DateTime       @default(now())

  @@index([projectId], map: "idx_agent_runs_project")
  @@index([status], map: "idx_agent_runs_status")
  @@map("agent_runs")
}

model AgentRunEvent {
  id          String         @id @default(uuid())
  agentRunId  String         @map("agent_run_id")
  step        Int
  eventType   AgentEventType @map("event_type")
  payloadJson Json           @map("payload_json")
  createdAt   DateTime       @default(now())

  @@index([agentRunId], map: "idx_agent_run_events_run")
  @@map("agent_run_events")
}

model GitProvider {
  id                  String          @id @default(uuid())
  orgId               String          @map("org_id")
  type                GitProviderType
  name                String
  apiBaseUrl          String?         @map("api_base_url")
  appId               String?         @map("app_id")
  privateKeyEncrypted String?         @map("private_key_encrypted")
  createdAt           DateTime        @default(now())

  @@map("git_providers")
}

model GitInstallation {
  id                     String   @id @default(uuid())
  providerId             String   @map("provider_id")
  orgId                  String   @map("org_id")
  externalInstallationId String   @map("external_installation_id")
  accountName            String?  @map("account_name")
  accountType            String?  @map("account_type")
  permissions            Json?
  createdAt              DateTime @default(now())

  @@map("git_installations")
}

model Commit {
  id               String           @id @default(uuid())
  projectId        String           @map("project_id")
  repoId           String?          @map("repo_id")
  sha              String
  branch           String
  message          String
  authorType       CommitAuthorType @map("author_type")
  authorUserId     String?          @map("author_user_id")
  authorAgentRunId String?          @map("author_agent_run_id")
  filesChanged     Int?             @map("files_changed")
  additions        Int?
  deletions        Int?
  createdAt        DateTime         @default(now())

  @@index([projectId], map: "idx_commits_project")
  @@map("commits")
}

model Notification {
  id           String               @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId       String               @map("user_id") @db.Uuid
  orgId        String?              @map("org_id") @db.Uuid
  projectId    String?              @map("project_id") @db.Uuid
  channel      NotificationChannel? @default(in_app)
  type         String               @db.VarChar(100)
  title        String               @db.VarChar(255)
  body         String?
  data         Json?
  readAt       DateTime?            @map("read_at") @db.Timestamptz(6)
  snoozedUntil DateTime?            @map("snoozed_until") @db.Timestamptz(6)
  created_at   DateTime?            @default(now()) @db.Timestamptz(6)

  @@index([userId], map: "idx_notifications_user")
  @@map("notifications")
}

enum ProjectStatus {
  draft
  active
  paused
  archived
  complete

  @@map("project_status")
}

enum GitProviderType {
  github
  gitlab
  bitbucket
  local

  @@map("git_provider")
}

enum FeatureStatus {
  pending
  in_progress
  passing
  failing
  blocked

  @@map("feature_status")
}

enum WorkItemType {
  epic
  story
  task
  bug
  subtask

  @@map("work_item_type")
}

enum WorkItemStatus {
  idea
  ready
  in_progress
  in_review
  done
  released
  blocked

  @@map("work_item_status")
}

enum LinkType {
  blocks
  is_blocked_by
  relates_to
  tests
  duplicates

  @@map("link_type")
}

enum TestCaseType {
  unit
  integration
  e2e
  regression
  smoke
  performance
  accessibility

  @@map("test_case_type")
}

enum TestRunStatus {
  pending
  running
  passed
  failed
  cancelled

  @@map("test_run_status")
}

enum AgentType {
  initializer
  coding
  planner
  qa
  release
  analytics

  @@map("agent_type")
}

enum AgentRunStatus {
  queued
  running
  completed
  failed
  cancelled

  @@map("agent_run_status")
}

enum AgentEventType {
  tool_call
  tool_result
  message
  test_run
  commit
  error
  status_change

  @@map("agent_event_type")
}

enum CommitAuthorType {
  user
  agent

  @@map("commit_author_type")
}

enum NotificationChannel {
  in_app
  email
  slack
  webhook

  @@map("notification_channel")
}

// ============================================
// ACD Enhanced Tracking Models
// ============================================

// Target: Tracks repos from repo-queue.json
model Target {
  id              String           @id @default(uuid())
  repoId          String           @unique @map("repo_id")
  name            String
  path            String
  priority        Int              @default(99)
  complexity      TargetComplexity @default(medium)
  enabled         Boolean          @default(true)
  focus           String?
  totalFeatures   Int              @default(0) @map("total_features")
  passingFeatures Int              @default(0) @map("passing_features")
  percentComplete Float            @default(0) @map("percent_complete")
  lastSessionAt   DateTime?        @map("last_session_at")
  lastModel       String?          @map("last_model")
  status          TargetStatus     @default(pending)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  sessions        HarnessSession[]
  snapshots       ProgressSnapshot[]
  features        TargetFeature[]
  codebaseIndexes CodebaseIndex[]
  fileAccessLogs  FileAccessLog[]

  // Codebase metrics
  lastIndexedAt   DateTime? @map("last_indexed_at")
  indexSizeTokens Int       @default(0) @map("index_size_tokens")
  totalFiles      Int       @default(0) @map("total_files")
  totalLoc        Int       @default(0) @map("total_loc")

  @@index([repoId], map: "idx_targets_repo_id")
  @@index([status], map: "idx_targets_status")
  @@map("targets")
}

// HarnessSession: Tracks each harness run
model HarnessSession {
  id                 String               @id @default(uuid())
  targetId           String               @map("target_id")
  sessionNumber      Int                  @map("session_number")
  sessionType        String               @map("session_type")
  model              String
  status             HarnessSessionStatus @default(running)
  featuresBefore     Int                  @default(0) @map("features_before")
  featuresAfter      Int                  @default(0) @map("features_after")
  featuresCompleted  Int                  @default(0) @map("features_completed")
  inputTokens        Int                  @default(0) @map("input_tokens")
  outputTokens       Int                  @default(0) @map("output_tokens")
  cacheReadTokens    Int                  @default(0) @map("cache_read_tokens")
  cacheWriteTokens   Int                  @default(0) @map("cache_write_tokens")
  costUsd            Float                @default(0) @map("cost_usd")
  durationMs         Int                  @default(0) @map("duration_ms")
  apiLatencyMs       Int                  @default(0) @map("api_latency_ms")
  wallClockMs        Int                  @default(0) @map("wall_clock_ms")
  turnCount          Int                  @default(0) @map("turn_count")
  retryCount         Int                  @default(0) @map("retry_count")
  modelFallbacks     Int                  @default(0) @map("model_fallbacks")
  testsRun           Int                  @default(0) @map("tests_run")
  testsPassed        Int                  @default(0) @map("tests_passed")
  testsFailed        Int                  @default(0) @map("tests_failed")
  testPassRate       Float?               @map("test_pass_rate")
  contextUtilization Float?               @map("context_utilization")
  cacheHitRate       Float?               @map("cache_hit_rate")
  errorType          String?              @map("error_type")
  errorMessage       String?              @map("error_message")
  commitsMade        Int                  @default(0) @map("commits_made")
  startedAt          DateTime             @default(now()) @map("started_at")
  finishedAt         DateTime?            @map("finished_at")
  createdAt          DateTime             @default(now())

  target  Target         @relation(fields: [targetId], references: [id])
  turns   SessionTurn[]
  retries SessionRetry[]

  @@index([targetId], map: "idx_harness_sessions_target")
  @@index([status], map: "idx_harness_sessions_status")
  @@index([startedAt], map: "idx_harness_sessions_started")
  @@map("harness_sessions")
}

// ProgressSnapshot: Daily/hourly progress tracking
model ProgressSnapshot {
  id              String   @id @default(uuid())
  targetId        String   @map("target_id")
  totalFeatures   Int      @map("total_features")
  passingFeatures Int      @map("passing_features")
  percentComplete Float    @map("percent_complete")
  sessionsToday   Int      @default(0) @map("sessions_today")
  tokensToday     Int      @default(0) @map("tokens_today")
  costToday       Float    @default(0) @map("cost_today")
  snapshotDate    DateTime @map("snapshot_date") @db.Date
  createdAt       DateTime @default(now())

  target Target @relation(fields: [targetId], references: [id])

  @@unique([targetId, snapshotDate])
  @@index([targetId], map: "idx_progress_snapshots_target")
  @@index([snapshotDate], map: "idx_progress_snapshots_date")
  @@map("progress_snapshots")
}

// ModelUsage: Track model usage and costs
model ModelUsage {
  id           String   @id @default(uuid())
  model        String
  inputTokens  Int      @default(0) @map("input_tokens")
  outputTokens Int      @default(0) @map("output_tokens")
  totalTokens  Int      @default(0) @map("total_tokens")
  costUsd      Float    @default(0) @map("cost_usd")
  requestCount Int      @default(1) @map("request_count")
  usageDate    DateTime @map("usage_date") @db.Date
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([model, usageDate])
  @@index([model], map: "idx_model_usage_model")
  @@index([usageDate], map: "idx_model_usage_date")
  @@map("model_usage")
}

// QueueStatus: Track overall queue state
model QueueStatus {
  id               String    @id @default(uuid())
  currentTargetId  String?   @map("current_target_id")
  queueStartedAt   DateTime? @map("queue_started_at")
  totalSessions    Int       @default(0) @map("total_sessions")
  totalTokens      Int       @default(0) @map("total_tokens")
  totalCostUsd     Float     @default(0) @map("total_cost_usd")
  completedTargets Int       @default(0) @map("completed_targets")
  isRunning        Boolean   @default(false) @map("is_running")
  lastUpdated      DateTime  @default(now()) @map("last_updated")
  createdAt        DateTime  @default(now())

  @@map("queue_status")
}

enum TargetComplexity {
  low
  medium
  high

  @@map("target_complexity")
}

enum TargetStatus {
  pending
  active
  complete
  paused
  error

  @@map("target_status")
}

enum HarnessSessionStatus {
  running
  completed
  failed
  cancelled

  @@map("harness_session_status")
}

// ============================================
// Enhanced Tracking Models
// ============================================

// TargetFeature: Individual features from feature_list.json
model TargetFeature {
  id            String    @id @default(uuid())
  targetId      String    @map("target_id")
  featureKey    String    @map("feature_key")
  name          String
  description   String?
  category      String?
  priority      Int       @default(50)
  status        String    @default("pending")
  passes        Boolean   @default(false)
  implementedAt DateTime? @map("implemented_at")
  sessionId     String?   @map("session_id")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  target Target @relation(fields: [targetId], references: [id])

  @@unique([targetId, featureKey])
  @@index([targetId], map: "idx_target_features_target")
  @@index([status], map: "idx_target_features_status")
  @@map("target_features")
}

// HarnessLog: Logs from harness runs
model HarnessLog {
  id        String   @id @default(uuid())
  sessionId String   @map("session_id")
  level     String   @default("info")
  message   String
  metadata  Json?
  timestamp DateTime @default(now())

  @@index([sessionId], map: "idx_harness_logs_session")
  @@index([level], map: "idx_harness_logs_level")
  @@index([timestamp], map: "idx_harness_logs_timestamp")
  @@map("harness_logs")
}

// HarnessCommit: Git commits made during sessions
model HarnessCommit {
  id           String   @id @default(uuid())
  sessionId    String   @map("session_id")
  targetId     String   @map("target_id")
  sha          String
  message      String
  filesChanged Int      @default(0) @map("files_changed")
  additions    Int      @default(0)
  deletions    Int      @default(0)
  branch       String   @default("main")
  createdAt    DateTime @default(now())

  @@index([sessionId], map: "idx_harness_commits_session")
  @@index([targetId], map: "idx_harness_commits_target")
  @@map("harness_commits")
}

// HarnessError: Detailed error tracking
model HarnessError {
  id         String    @id @default(uuid())
  sessionId  String?   @map("session_id")
  targetId   String    @map("target_id")
  errorType  String    @map("error_type")
  errorCode  String?   @map("error_code")
  message    String
  stackTrace String?   @map("stack_trace")
  context    Json?
  resolved   Boolean   @default(false)
  resolvedAt DateTime? @map("resolved_at")
  createdAt  DateTime  @default(now())

  @@index([targetId], map: "idx_harness_errors_target")
  @@index([errorType], map: "idx_harness_errors_type")
  @@index([resolved], map: "idx_harness_errors_resolved")
  @@map("harness_errors")
}

// TokenUsageDetail: Granular token tracking
model TokenUsageDetail {
  id               String   @id @default(uuid())
  sessionId        String   @map("session_id")
  model            String
  inputTokens      Int      @default(0) @map("input_tokens")
  outputTokens     Int      @default(0) @map("output_tokens")
  cacheReadTokens  Int      @default(0) @map("cache_read_tokens")
  cacheWriteTokens Int      @default(0) @map("cache_write_tokens")
  costUsd          Float    @default(0) @map("cost_usd")
  toolName         String?  @map("tool_name")
  createdAt        DateTime @default(now())

  @@index([sessionId], map: "idx_token_usage_session")
  @@index([model], map: "idx_token_usage_model")
  @@map("token_usage_details")
}

// SessionTurn: Turn-by-turn metrics within a session
model SessionTurn {
  id           String    @id @default(uuid())
  sessionId    String    @map("session_id")
  turnNumber   Int       @map("turn_number")
  inputTokens  Int       @default(0) @map("input_tokens")
  outputTokens Int       @default(0) @map("output_tokens")
  toolCalls    Json?     @map("tool_calls")
  startedAt    DateTime  @default(now()) @map("started_at")
  finishedAt   DateTime? @map("finished_at")
  durationMs   Int       @default(0) @map("duration_ms")
  createdAt    DateTime  @default(now())

  session HarnessSession @relation(fields: [sessionId], references: [id])

  @@index([sessionId], map: "idx_session_turns_session")
  @@map("session_turns")
}

// SessionRetry: Track retry attempts
model SessionRetry {
  id             String   @id @default(uuid())
  sessionId      String   @map("session_id")
  retryNumber    Int      @map("retry_number")
  reason         String // rate_limit, error, timeout, model_fallback
  originalModel  String?  @map("original_model")
  fallbackModel  String?  @map("fallback_model")
  waitDurationMs Int      @default(0) @map("wait_duration_ms")
  succeeded      Boolean  @default(false)
  errorMessage   String?  @map("error_message")
  createdAt      DateTime @default(now())

  session HarnessSession @relation(fields: [sessionId], references: [id])

  @@index([sessionId], map: "idx_session_retries_session")
  @@map("session_retries")
}

// CodebaseIndex: Track codebase size and structure
model CodebaseIndex {
  id              String   @id @default(uuid())
  targetId        String   @map("target_id")
  totalFiles      Int      @default(0) @map("total_files")
  totalLines      Int      @default(0) @map("total_lines")
  totalSizeBytes  BigInt   @default(0) @map("total_size_bytes")
  indexSizeTokens Int      @default(0) @map("index_size_tokens")
  buildDurationMs Int      @default(0) @map("build_duration_ms")
  fileTypes       Json?    @map("file_types") // {"ts": 150, "js": 50}
  largestFiles    Json?    @map("largest_files") // Top 10 by size
  indexedAt       DateTime @default(now()) @map("indexed_at")
  createdAt       DateTime @default(now())

  target Target @relation(fields: [targetId], references: [id])

  @@index([targetId], map: "idx_codebase_index_target")
  @@map("codebase_indexes")
}

// ContextUsage: Track context window utilization per session
model ContextUsage {
  id                 String   @id @default(uuid())
  sessionId          String   @map("session_id")
  turnNumber         Int      @default(0) @map("turn_number")
  systemTokens       Int      @default(0) @map("system_tokens")
  featureTokens      Int      @default(0) @map("feature_tokens")
  fileTokens         Int      @default(0) @map("file_tokens")
  conversationTokens Int      @default(0) @map("conversation_tokens")
  totalTokens        Int      @default(0) @map("total_tokens")
  contextLimit       Int      @default(200000) @map("context_limit")
  utilization        Float    @default(0)
  overflowOccurred   Boolean  @default(false) @map("overflow_occurred")
  createdAt          DateTime @default(now())

  @@index([sessionId], map: "idx_context_usage_session")
  @@map("context_usage")
}

// FileAccessLog: Track frequently accessed files for caching
model FileAccessLog {
  id             String   @id @default(uuid())
  targetId       String   @map("target_id")
  filePath       String   @map("file_path")
  accessCount    Int      @default(1) @map("access_count")
  avgTokens      Int      @default(0) @map("avg_tokens")
  isCached       Boolean  @default(false) @map("is_cached")
  lastAccessedAt DateTime @default(now()) @map("last_accessed_at")
  createdAt      DateTime @default(now())

  target Target @relation(fields: [targetId], references: [id])

  @@unique([targetId, filePath])
  @@index([targetId], map: "idx_file_access_target")
  @@index([accessCount], map: "idx_file_access_count")
  @@map("file_access_log")
}

// ============================================
// Programmatic Creative Testing Models
// ============================================

model PctBrand {
  id          String   @id @default(uuid())
  orgId       String?  @map("org_id")
  name        String
  description String?
  voice       String?
  values      String?
  toneStyle   String?  @map("tone_style")
  logoUrl     String?  @map("logo_url")
  colors      Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products PctProduct[]

  @@index([orgId], map: "idx_pct_brands_org")
  @@map("pct_brands")
}

model PctProduct {
  id             String   @id @default(uuid())
  brandId        String   @map("brand_id")
  name           String
  description    String?
  features       Json?
  benefits       Json?
  targetAudience String?  @map("target_audience")
  pricePoint     String?  @map("price_point")
  category       String?
  imageUrl       String?  @map("image_url")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  brand           PctBrand             @relation(fields: [brandId], references: [id], onDelete: Cascade)
  voiceOfCustomer PctVoiceOfCustomer[]
  usps            PctUSP[]
  hooks           PctHook[]
  templates       PctTemplate[]

  @@index([brandId], map: "idx_pct_products_brand")
  @@map("pct_products")
}

model PctVoiceOfCustomer {
  id           String           @id @default(uuid())
  productId    String           @map("product_id")
  content      String
  source       String?
  sourceType   PctVocSourceType @default(other) @map("source_type")
  sentiment    PctSentiment     @default(neutral)
  isGoldNugget Boolean          @default(false) @map("is_gold_nugget")
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  product PctProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId], map: "idx_pct_voc_product")
  @@map("pct_voice_of_customer")
}

model PctUSP {
  id            String    @id @default(uuid())
  productId     String    @map("product_id")
  content       String
  isAiGenerated Boolean   @default(false) @map("is_ai_generated")
  strengthScore Int?      @map("strength_score")
  archivedAt    DateTime? @map("archived_at")
  archiveNote   String?   @map("archive_note")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  product PctProduct          @relation(fields: [productId], references: [id], onDelete: Cascade)
  angles  PctMarketingAngle[]
  hooks   PctHook[]

  @@index([productId], map: "idx_pct_usps_product")
  @@map("pct_usps")
}

// F10.1.4: Activity Log for user actions
model PctActivityLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  userName   String?  @map("user_name")
  action     String // e.g. "created_usp", "archived_usp", "generated_hooks"
  entityType String?  @map("entity_type") // brand, product, usp, hook, etc.
  entityId   String?  @map("entity_id")
  details    Json?
  createdAt  DateTime @default(now())

  @@index([userId], map: "idx_pct_activity_user")
  @@index([action], map: "idx_pct_activity_action")
  @@index([createdAt], map: "idx_pct_activity_created")
  @@map("pct_activity_logs")
}

// F10.1.1/F10.1.2/F10.1.3: PCT User + Role management
model PctUser {
  id           String    @id @default(uuid())
  email        String    @unique
  name         String
  passwordHash String    @map("password_hash")
  role         String    @default("viewer") // admin, editor, viewer
  workspaceId  String?   @map("workspace_id")
  avatarUrl    String?   @map("avatar_url")
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([email], map: "idx_pct_users_email")
  @@index([workspaceId], map: "idx_pct_users_workspace")
  @@map("pct_users")
}

// F10.1.3: Team Workspace
model PctWorkspace {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  plan      String   @default("free")
  ownerId   String?  @map("owner_id")
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug], map: "idx_pct_workspaces_slug")
  @@map("pct_workspaces")
}

model PctMarketingAngle {
  id         String           @id @default(uuid())
  uspId      String           @map("usp_id")
  content    String
  category   PctAngleCategory @default(functional)
  isApproved Boolean          @default(false) @map("is_approved")
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  usp   PctUSP    @relation(fields: [uspId], references: [id], onDelete: Cascade)
  hooks PctHook[]

  @@index([uspId], map: "idx_pct_angles_usp")
  @@map("pct_marketing_angles")
}

model PctHook {
  id                   String                @id @default(uuid())
  productId            String                @map("product_id")
  uspId                String?               @map("usp_id")
  marketingAngleId     String?               @map("marketing_angle_id")
  content              String
  status               PctHookStatus         @default(pending)
  rating               Int?
  messagingFramework   PctMessagingFramework @map("messaging_framework")
  awarenessLevel       Int                   @map("awareness_level")
  marketSophistication Int                   @map("market_sophistication")
  isAiGenerated        Boolean               @default(true) @map("is_ai_generated")
  tags                 Json                  @default("[]")
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  product      PctProduct         @relation(fields: [productId], references: [id], onDelete: Cascade)
  usp          PctUSP?            @relation(fields: [uspId], references: [id], onDelete: SetNull)
  angle        PctMarketingAngle? @relation(fields: [marketingAngleId], references: [id], onDelete: SetNull)
  generatedAds PctGeneratedAd[]
  videoScripts PctVideoScript[]

  @@index([productId], map: "idx_pct_hooks_product")
  @@index([uspId], map: "idx_pct_hooks_usp")
  @@index([status], map: "idx_pct_hooks_status")
  @@map("pct_hooks")
}

enum PctVocSourceType {
  amazon
  reddit
  forum
  survey
  review_site
  social_media
  other

  @@map("pct_voc_source_type")
}

enum PctSentiment {
  positive
  negative
  neutral

  @@map("pct_sentiment")
}

enum PctAngleCategory {
  emotional
  functional
  social_proof

  @@map("pct_angle_category")
}

enum PctHookStatus {
  pending
  approved
  rejected

  @@map("pct_hook_status")
}

enum PctMessagingFramework {
  punchy
  bold_statements
  desire_future_states
  question_based
  problem_agitation
  social_proof
  urgency_scarcity
  educational

  @@map("pct_messaging_framework")
}

// ============================================
// PCT Static Ad Creation Models (P1)
// ============================================

model PctTemplate {
  id        String   @id @default(uuid())
  productId String?  @map("product_id")
  name      String
  imageUrl  String   @map("image_url")
  width     Int
  height    Int
  textZones Json     @default("[]") @map("text_zones")
  category  String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product      PctProduct?      @relation(fields: [productId], references: [id], onDelete: SetNull)
  generatedAds PctGeneratedAd[]

  @@index([productId], map: "idx_pct_templates_product")
  @@map("pct_templates")
}

model PctGeneratedAd {
  id           String      @id @default(uuid())
  templateId   String      @map("template_id")
  hookId       String      @map("hook_id")
  imageDataUrl String      @map("image_data_url")
  width        Int
  height       Int
  status       PctAdStatus @default(pending)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  template    PctTemplate       @relation(fields: [templateId], references: [id], onDelete: Cascade)
  hook        PctHook           @relation(fields: [hookId], references: [id], onDelete: Cascade)
  deployments PctAdDeployment[]

  @@index([templateId], map: "idx_pct_generated_ads_template")
  @@index([hookId], map: "idx_pct_generated_ads_hook")
  @@index([status], map: "idx_pct_generated_ads_status")
  @@map("pct_generated_ads")
}

enum PctAdStatus {
  pending
  approved
  rejected
  deployed

  @@map("pct_ad_status")
}

// ============================================
// VIDEO SCRIPTS
// ============================================

model PctVideoScript {
  id            String            @id @default(uuid())
  hookId        String            @map("hook_id")
  productId     String            @map("product_id")
  title         String?
  hook          String
  lid           String
  body          String
  cta           String
  fullScript    String            @map("full_script")
  duration      PctScriptDuration @default(thirty_seconds)
  narratorStyle String?           @map("narrator_style")
  wordCount     Int               @map("word_count")
  status        PctScriptStatus   @default(draft)
  isAiGenerated Boolean           @default(true) @map("is_ai_generated")
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  hookRef PctHook @relation(fields: [hookId], references: [id], onDelete: Cascade)

  @@index([hookId], map: "idx_pct_scripts_hook")
  @@index([productId], map: "idx_pct_scripts_product")
  @@index([status], map: "idx_pct_scripts_status")
  @@map("pct_video_scripts")
}

enum PctScriptDuration {
  fifteen_seconds
  thirty_seconds
  sixty_seconds
  ninety_seconds

  @@map("pct_script_duration")
}

enum PctScriptStatus {
  draft
  approved
  rejected

  @@map("pct_script_status")
}

// ============================================
// PCT Meta Deployment Models (Module 7)
// ============================================

// Meta Business account connection
model PctMetaAccount {
  id                String    @id @default(uuid())
  name              String
  accessToken       String    @map("access_token")
  accessTokenExpiry DateTime? @map("access_token_expiry")
  adAccountId       String?   @map("ad_account_id")
  adAccountName     String?   @map("ad_account_name")
  businessId        String?   @map("business_id")
  businessName      String?   @map("business_name")
  isActive          Boolean   @default(true) @map("is_active")
  lastSyncAt        DateTime? @map("last_sync_at")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  campaigns   PctMetaCampaign[]
  deployments PctAdDeployment[]

  @@index([isActive], map: "idx_pct_meta_accounts_active")
  @@map("pct_meta_accounts")
}

// Mirror of Meta campaigns
model PctMetaCampaign {
  id             String   @id @default(uuid())
  metaAccountId  String   @map("meta_account_id")
  metaCampaignId String   @unique @map("meta_campaign_id")
  name           String
  objective      String?
  status         String   @default("ACTIVE")
  budgetCents    Int?     @map("budget_cents")
  budgetType     String?  @map("budget_type") // daily, lifetime
  syncedAt       DateTime @default(now()) @map("synced_at")
  createdAt      DateTime @default(now())

  metaAccount PctMetaAccount @relation(fields: [metaAccountId], references: [id], onDelete: Cascade)
  adSets      PctMetaAdSet[]

  @@index([metaAccountId], map: "idx_pct_meta_campaigns_account")
  @@map("pct_meta_campaigns")
}

// Mirror of Meta ad sets
model PctMetaAdSet {
  id          String   @id @default(uuid())
  campaignId  String   @map("campaign_id")
  metaAdSetId String   @unique @map("meta_ad_set_id")
  name        String
  status      String   @default("ACTIVE")
  targeting   Json?
  budgetCents Int?     @map("budget_cents")
  budgetType  String?  @map("budget_type")
  syncedAt    DateTime @default(now()) @map("synced_at")
  createdAt   DateTime @default(now())

  campaign    PctMetaCampaign   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  deployments PctAdDeployment[]

  @@index([campaignId], map: "idx_pct_meta_adsets_campaign")
  @@map("pct_meta_ad_sets")
}

// Tracks ads pushed to Meta
model PctAdDeployment {
  id              String              @id @default(uuid())
  generatedAdId   String              @map("generated_ad_id")
  metaAccountId   String              @map("meta_account_id")
  adSetId         String?             @map("ad_set_id")
  metaAdId        String?             @unique @map("meta_ad_id")
  headline        String?
  bodyText        String?
  ctaText         String?
  destinationUrl  String?             @map("destination_url")
  status          PctDeploymentStatus @default(pending)
  errorMessage    String?             @map("error_message")
  reviewStatus    String?             @map("review_status")
  rejectionReason String?             @map("rejection_reason")
  livePreviewUrl  String?             @map("live_preview_url")
  pushedAt        DateTime?           @map("pushed_at")
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  generatedAd   PctGeneratedAd         @relation(fields: [generatedAdId], references: [id], onDelete: Cascade)
  metaAccount   PctMetaAccount         @relation(fields: [metaAccountId], references: [id], onDelete: Cascade)
  adSet         PctMetaAdSet?          @relation(fields: [adSetId], references: [id], onDelete: SetNull)
  metrics       PctPerformanceMetric[]
  fatigueAlerts PctFatigueAlert[]

  @@index([generatedAdId], map: "idx_pct_deployments_ad")
  @@index([metaAccountId], map: "idx_pct_deployments_account")
  @@index([status], map: "idx_pct_deployments_status")
  @@map("pct_ad_deployments")
}

enum PctDeploymentStatus {
  pending
  queued
  pushing
  success
  failed
  rejected

  @@map("pct_deployment_status")
}

// ============================================
// PCT Analytics & Iteration Models (Module 8)
// ============================================

// Performance metrics imported from Meta for deployed ads
model PctPerformanceMetric {
  id              String   @id @default(uuid())
  deploymentId    String   @map("deployment_id")
  date            DateTime @db.Date
  impressions     Int      @default(0)
  clicks          Int      @default(0)
  spend           Float    @default(0) // in dollars
  reach           Int      @default(0)
  ctr             Float? // click-through rate
  cpc             Float? // cost per click
  cpm             Float? // cost per mille
  conversions     Int      @default(0)
  conversionValue Float?   @map("conversion_value")
  roas            Float? // return on ad spend
  frequency       Float?
  syncedAt        DateTime @default(now()) @map("synced_at")
  createdAt       DateTime @default(now())

  deployment PctAdDeployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  @@unique([deploymentId, date])
  @@index([deploymentId], map: "idx_pct_metrics_deployment")
  @@index([date], map: "idx_pct_metrics_date")
  @@map("pct_performance_metrics")
}

// Iteration history: tracks "create more like winner" actions
model PctIterationHistory {
  id             String   @id @default(uuid())
  productId      String   @map("product_id")
  iterationType  String   @map("iteration_type") // expand_angle, new_hooks, new_templates, ab_test
  sourceId       String   @map("source_id") // ID of the winning hook/angle/template
  sourceType     String   @map("source_type") // hook, angle, usp, template
  parameters     Json     @default("{}") // which parameters were used
  generatedCount Int      @default(0) @map("generated_count")
  notes          String?
  createdAt      DateTime @default(now())

  @@index([productId], map: "idx_pct_iterations_product")
  @@index([sourceId], map: "idx_pct_iterations_source")
  @@map("pct_iteration_history")
}

// ============================================
// PCT-063/064: Hook Examples Database for AI Learning
// ============================================

model PctHookExample {
  id                   String                @id @default(uuid())
  hookText             String                @map("hook_text")
  messagingFramework   PctMessagingFramework @map("messaging_framework")
  industry             String?
  niche                String?
  awarenessLevel       Int?                  @map("awareness_level")
  marketSophistication Int?                  @map("market_sophistication")
  source               String                @default("swipe_file") // internal_winner, swipe_file, competitor
  sourceUrl            String?               @map("source_url")
  performanceScore     Float?                @map("performance_score")
  tags                 Json                  @default("[]")
  isActive             Boolean               @default(true) @map("is_active")
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  @@index([messagingFramework], map: "idx_pct_hook_examples_framework")
  @@index([industry], map: "idx_pct_hook_examples_industry")
  @@index([isActive], map: "idx_pct_hook_examples_active")
  @@map("pct_hook_examples")
}

// ============================================
// PCT-067: Ad Inspiration References
// ============================================

model PctAdInspiration {
  id             String   @id @default(uuid())
  productId      String?  @map("product_id")
  title          String?
  sourceUrl      String?  @map("source_url")
  imageUrl       String?  @map("image_url")
  adCopy         String?  @map("ad_copy")
  hookExtracted  String?  @map("hook_extracted")
  ctaExtracted   String?  @map("cta_extracted")
  structureNotes String?  @map("structure_notes")
  tags           Json     @default("[]")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([productId], map: "idx_pct_ad_inspirations_product")
  @@map("pct_ad_inspirations")
}

// ============================================
// PCT-070/071/072: Advanced Analytics Models
// ============================================

model PctFatigueAlert {
  id              String   @id @default(uuid())
  deploymentId    String   @map("deployment_id")
  alertType       String   @map("alert_type") // declining_ctr, increasing_cpc, frequency_cap
  metric          String // ctr, cpc, frequency
  previousValue   Float    @map("previous_value")
  currentValue    Float    @map("current_value")
  declinePercent  Float    @map("decline_percent")
  suggestedAction String?  @map("suggested_action")
  isAcknowledged  Boolean  @default(false) @map("is_acknowledged")
  createdAt       DateTime @default(now())

  deployment PctAdDeployment @relation(fields: [deploymentId], references: [id], onDelete: Cascade)

  @@index([deploymentId], map: "idx_pct_fatigue_alerts_deployment")
  @@index([isAcknowledged], map: "idx_pct_fatigue_alerts_ack")
  @@map("pct_fatigue_alerts")
}

model PctStatisticalTest {
  id                String   @id @default(uuid())
  testName          String   @map("test_name")
  controlId         String   @map("control_id")
  variantId         String   @map("variant_id")
  metric            String // ctr, cpc, roas, cvr
  controlValue      Float    @map("control_value")
  variantValue      Float    @map("variant_value")
  pValue            Float    @map("p_value")
  confidenceLevel   Float    @map("confidence_level")
  sampleSizeControl Int      @map("sample_size_control")
  sampleSizeVariant Int      @map("sample_size_variant")
  isSignificant     Boolean  @default(false) @map("is_significant")
  winner            String? // control, variant, none
  createdAt         DateTime @default(now())

  @@index([controlId], map: "idx_pct_stat_tests_control")
  @@index([variantId], map: "idx_pct_stat_tests_variant")
  @@map("pct_statistical_tests")
}

// ============================================
// PCT-076/077/078: Audience Management
// ============================================

model PctAudience {
  id              String    @id @default(uuid())
  metaAccountId   String?   @map("meta_account_id")
  name            String
  audienceType    String    @map("audience_type") // lookalike, custom, interest, saved
  description     String?
  size            Int?
  sourceType      String?   @map("source_type") // voc, crm, website, purchase
  targeting       Json? // interest targeting, demographics
  metaAudienceId  String?   @map("meta_audience_id")
  refreshSchedule String?   @map("refresh_schedule") // daily, weekly, monthly
  lastRefreshedAt DateTime? @map("last_refreshed_at")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([metaAccountId], map: "idx_pct_audiences_account")
  @@index([audienceType], map: "idx_pct_audiences_type")
  @@map("pct_audiences")
}

// ============================================
// PCT-079/080/081: Budget Management
// ============================================

model PctBudgetRule {
  id             String    @id @default(uuid())
  metaAccountId  String?   @map("meta_account_id")
  name           String
  ruleType       String    @map("rule_type") // allocate, bid_cap, pacing
  targetRoas     Float?    @map("target_roas")
  minBudgetCents Int?      @map("min_budget_cents")
  maxBudgetCents Int?      @map("max_budget_cents")
  conditions     Json      @default("{}") // trigger conditions
  schedule       Json? // when to apply
  isActive       Boolean   @default(true) @map("is_active")
  lastAppliedAt  DateTime? @map("last_applied_at")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([metaAccountId], map: "idx_pct_budget_rules_account")
  @@map("pct_budget_rules")
}

model PctSpendPacing {
  id                String   @id @default(uuid())
  metaAccountId     String   @map("meta_account_id")
  date              DateTime @db.Date
  dailyBudgetCents  Int      @map("daily_budget_cents")
  actualSpendCents  Int      @map("actual_spend_cents")
  pacingStatus      String   @map("pacing_status") // on_track, over_pace, under_pace
  forecastedMonthly Float?   @map("forecasted_monthly")
  createdAt         DateTime @default(now())

  @@unique([metaAccountId, date])
  @@index([metaAccountId], map: "idx_pct_spend_pacing_account")
  @@map("pct_spend_pacing")
}

// ============================================
// PCT-082-085: Creative Templates
// ============================================

model PctCreativeTemplate {
  id              String   @id @default(uuid())
  templateType    String   @map("template_type") // ugc, before_after, testimonial, carousel
  name            String
  description     String?
  config          Json     @default("{}") // type-specific configuration
  previewImageUrl String?  @map("preview_image_url")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([templateType], map: "idx_pct_creative_templates_type")
  @@map("pct_creative_templates")
}

// ============================================
// PCT-086/087/088: Compliance
// ============================================

model PctComplianceCheck {
  id          String   @id @default(uuid())
  hookId      String?  @map("hook_id")
  adId        String?  @map("ad_id")
  checkType   String   @map("check_type") // policy, disclosure, landing_page
  status      String   @default("pending") // pending, passed, failed, warning
  issues      Json     @default("[]")
  suggestions Json     @default("[]")
  checkedAt   DateTime @default(now()) @map("checked_at")
  createdAt   DateTime @default(now())

  @@index([hookId], map: "idx_pct_compliance_hook")
  @@index([adId], map: "idx_pct_compliance_ad")
  @@map("pct_compliance_checks")
}

model PctDisclosureRule {
  id             String   @id @default(uuid())
  industry       String
  ruleText       String   @map("rule_text")
  placementGuide String?  @map("placement_guide")
  isRequired     Boolean  @default(true) @map("is_required")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([industry], map: "idx_pct_disclosure_rules_industry")
  @@map("pct_disclosure_rules")
}

// ============================================
// PCT-089/090/091: Testing Frameworks
// ============================================

model PctTestPlan {
  id             String    @id @default(uuid())
  productId      String?   @map("product_id")
  name           String
  testType       String    @map("test_type") // multivariate, sequential, geo_split
  status         String    @default("draft") // draft, running, completed, paused
  variables      Json      @default("[]") // what to test
  sampleSize     Int?      @map("sample_size")
  currentPhase   Int       @default(1) @map("current_phase")
  totalPhases    Int       @default(1) @map("total_phases")
  holdoutRegions Json?     @map("holdout_regions")
  results        Json?
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([productId], map: "idx_pct_test_plans_product")
  @@index([status], map: "idx_pct_test_plans_status")
  @@map("pct_test_plans")
}

// ============================================
// PCT-092/093/094: Reporting
// ============================================

model PctReport {
  id         String   @id @default(uuid())
  reportType String   @map("report_type") // weekly, monthly, custom, leaderboard
  title      String
  dateFrom   DateTime @map("date_from")
  dateTo     DateTime @map("date_to")
  data       Json     @default("{}")
  format     String   @default("json") // json, csv, pdf
  fileUrl    String?  @map("file_url")
  createdAt  DateTime @default(now())

  @@index([reportType], map: "idx_pct_reports_type")
  @@map("pct_reports")
}

// ============================================
// PCT-095/096: Automation Rules
// ============================================

model PctAutomationRule {
  id               String    @id @default(uuid())
  metaAccountId    String?   @map("meta_account_id")
  name             String
  ruleType         String    @map("rule_type") // auto_pause, auto_scale
  triggerMetric    String    @map("trigger_metric") // ctr, cpc, roas, spend
  triggerOperator  String    @map("trigger_operator") // lt, gt, eq, lte, gte
  triggerValue     Float     @map("trigger_value")
  gracePeriodHours Int       @default(24) @map("grace_period_hours")
  action           Json      @default("{}") // pause, scale_budget, etc.
  maxBudgetCents   Int?      @map("max_budget_cents")
  scaleType        String?   @map("scale_type") // gradual, immediate
  scalePercent     Float?    @map("scale_percent")
  isActive         Boolean   @default(true) @map("is_active")
  lastTriggeredAt  DateTime? @map("last_triggered_at")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([metaAccountId], map: "idx_pct_automation_rules_account")
  @@index([ruleType], map: "idx_pct_automation_rules_type")
  @@map("pct_automation_rules")
}

// ============================================
// PCT-098/099/100: Platform Integrations
// ============================================

model PctPlatformConnection {
  id           String    @id @default(uuid())
  platform     String // google_ads, tiktok, shopify, woocommerce
  name         String
  accessToken  String    @map("access_token")
  refreshToken String?   @map("refresh_token")
  tokenExpiry  DateTime? @map("token_expiry")
  accountId    String?   @map("account_id")
  settings     Json      @default("{}")
  isActive     Boolean   @default(true) @map("is_active")
  lastSyncAt   DateTime? @map("last_sync_at")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([platform], map: "idx_pct_platform_connections_platform")
  @@map("pct_platform_connections")
}

model PctConversionEvent {
  id               String   @id @default(uuid())
  platformId       String   @map("platform_id")
  platform         String // shopify, woocommerce, meta
  orderId          String?  @map("order_id")
  revenue          Float    @default(0)
  currency         String   @default("USD")
  productName      String?  @map("product_name")
  adId             String?  @map("ad_id")
  campaignId       String?  @map("campaign_id")
  attributionModel String?  @map("attribution_model")
  eventDate        DateTime @map("event_date")
  createdAt        DateTime @default(now())

  @@index([platformId], map: "idx_pct_conversions_platform")
  @@index([adId], map: "idx_pct_conversions_ad")
  @@index([eventDate], map: "idx_pct_conversions_date")
  @@map("pct_conversion_events")
}

// ============================================
// PCT-101-104: AI Features
// ============================================

model PctAiPrediction {
  id              String   @id @default(uuid())
  hookId          String?  @map("hook_id")
  adId            String?  @map("ad_id")
  predictedCtr    Float?   @map("predicted_ctr")
  predictedCpc    Float?   @map("predicted_cpc")
  predictedRoas   Float?   @map("predicted_roas")
  overallScore    Float    @map("overall_score")
  confidenceLevel Float    @map("confidence_level")
  factors         Json     @default("[]") // what influenced the prediction
  createdAt       DateTime @default(now())

  @@index([hookId], map: "idx_pct_ai_predictions_hook")
  @@index([adId], map: "idx_pct_ai_predictions_ad")
  @@map("pct_ai_predictions")
}

model PctAbTestHypothesis {
  id             String   @id @default(uuid())
  productId      String?  @map("product_id")
  hypothesis     String
  variable       String // hook, angle, framework, awareness, audience
  priority       String   @default("medium") // high, medium, low
  expectedImpact String?  @map("expected_impact")
  reasoning      String?
  status         String   @default("proposed") // proposed, testing, validated, rejected
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([productId], map: "idx_pct_ab_hypotheses_product")
  @@index([status], map: "idx_pct_ab_hypotheses_status")
  @@map("pct_ab_test_hypotheses")
}

// ============================================
// PCT-105/107/108: Workflow
// ============================================

model PctCreativeBrief {
  id             String   @id @default(uuid())
  productId      String?  @map("product_id")
  title          String
  objective      String?
  targetAudience String?  @map("target_audience")
  keyMessages    Json     @default("[]") @map("key_messages")
  toneOfVoice    String?  @map("tone_of_voice")
  constraints    Json?
  references     Json     @default("[]")
  status         String   @default("draft") // draft, approved, in_progress, completed
  createdBy      String?  @map("created_by")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([productId], map: "idx_pct_briefs_product")
  @@map("pct_creative_briefs")
}

model PctAssetVersion {
  id         String   @id @default(uuid())
  assetType  String   @map("asset_type") // hook, ad, template, script
  assetId    String   @map("asset_id")
  version    Int      @default(1)
  data       Json // full snapshot of the asset
  changeNote String?  @map("change_note")
  changedBy  String?  @map("changed_by")
  createdAt  DateTime @default(now())

  @@unique([assetType, assetId, version])
  @@index([assetId], map: "idx_pct_asset_versions_asset")
  @@map("pct_asset_versions")
}

model PctComment {
  id         String   @id @default(uuid())
  entityType String   @map("entity_type") // hook, ad, template, script, brief
  entityId   String   @map("entity_id")
  userId     String?  @map("user_id")
  userName   String?  @map("user_name")
  content    String
  mentions   Json     @default("[]") // @mentioned userIds
  parentId   String?  @map("parent_id") // for threaded replies
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([entityType, entityId], map: "idx_pct_comments_entity")
  @@index([userId], map: "idx_pct_comments_user")
  @@map("pct_comments")
}

// ============================================
// PCT-110: Push Notifications
// ============================================

model PctNotification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String // performance_alert, approval_request, fatigue_alert, budget_alert
  title     String
  message   String
  data      Json?
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now())

  @@index([userId], map: "idx_pct_notifications_user")
  @@index([isRead], map: "idx_pct_notifications_read")
  @@map("pct_notifications")
}

// ============================================
// PCT-114: Dark Mode / UI Preferences
// ============================================

model PctUserPreference {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  theme           String   @default("light") // light, dark, system
  dashboardLayout Json?    @map("dashboard_layout")
  widgetConfig    Json?    @map("widget_config")
  shortcuts       Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("pct_user_preferences")
}

// ============================================
// PCT-118/119: Security
// ============================================

model PctTwoFactorAuth {
  id            String    @id @default(uuid())
  userId        String    @unique @map("user_id")
  secret        String
  recoveryCodes Json      @default("[]") @map("recovery_codes")
  isEnabled     Boolean   @default(false) @map("is_enabled")
  enabledAt     DateTime? @map("enabled_at")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("pct_two_factor_auth")
}

model PctSsoConnection {
  id                String   @id @default(uuid())
  provider          String // google, microsoft
  clientId          String   @map("client_id")
  clientSecret      String   @map("client_secret")
  domainRestriction String?  @map("domain_restriction")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([provider], map: "idx_pct_sso_provider")
  @@map("pct_sso_connections")
}

// ============================================
// Content Factory Models
// ============================================

enum CfDossierStatus {
  active
  paused
  archived

  @@map("cf_dossier_status")
}

enum CfImageType {
  before
  after
  product
  lifestyle

  @@map("cf_image_type")
}

enum CfGenerationStatus {
  pending
  generating
  complete
  failed

  @@map("cf_generation_status")
}

enum CfVideoType {
  before_after
  demo
  reveal
  full_ad

  @@map("cf_video_type")
}

enum CfAspectRatio {
  portrait // 9:16
  square // 1:1
  landscape // 16:9

  @@map("cf_aspect_ratio")
}

enum CfContentStatus {
  draft
  ready
  published
  archived

  @@map("cf_content_status")
}

enum CfPlatform {
  tiktok
  instagram
  facebook

  @@map("cf_platform")
}

enum CfDisclosureType {
  paid_partnership
  affiliate
  sponsored

  @@map("cf_disclosure_type")
}

enum CfPublishStatus {
  published
  promoted
  completed

  @@map("cf_publish_status")
}

enum CfTestStatus {
  draft
  running
  completed

  @@map("cf_test_status")
}

// CF-001: Product Dossiers
model CfProductDossier {
  id             String          @id @default(uuid())
  name           String
  slug           String          @unique
  tiktokShopUrl  String?         @map("tiktok_shop_url")
  affiliateLink  String?         @map("affiliate_link")
  productPageUrl String?         @map("product_page_url")
  price          Float?
  discountPrice  Float?          @map("discount_price")
  benefits       Json            @default("[]")
  painPoints     Json            @default("[]") @map("pain_points")
  proofTypes     Json            @default("[]") @map("proof_types")
  targetAudience String?         @map("target_audience")
  category       String?
  niche          String?
  status         CfDossierStatus @default(active)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  images           CfGeneratedImage[]
  videos           CfGeneratedVideo[]
  scripts          CfScript[]
  assembledContent CfAssembledContent[]
  angleTests       CfAngleTest[]

  @@index([status], map: "idx_cf_dossiers_status")
  @@map("cf_product_dossiers")
}

// CF-002: Generated Images
model CfGeneratedImage {
  id            String             @id @default(uuid())
  dossierId     String             @map("dossier_id")
  type          CfImageType
  variantNumber Int                @default(1) @map("variant_number")
  prompt        String
  model         String             @default("nano-banana")
  imageUrl      String?            @map("image_url")
  thumbnailUrl  String?            @map("thumbnail_url")
  status        CfGenerationStatus @default(pending)
  errorMessage  String?            @map("error_message")
  createdAt     DateTime           @default(now())

  dossier CfProductDossier   @relation(fields: [dossierId], references: [id], onDelete: Cascade)
  videos  CfGeneratedVideo[]

  @@index([dossierId], map: "idx_cf_images_dossier")
  @@index([type], map: "idx_cf_images_type")
  @@map("cf_generated_images")
}

// CF-003: Generated Videos
model CfGeneratedVideo {
  id              String             @id @default(uuid())
  dossierId       String             @map("dossier_id")
  sourceImageId   String?            @map("source_image_id")
  type            CfVideoType
  prompt          String
  model           String             @default("veo-3.1")
  durationSeconds Int                @default(8) @map("duration_seconds")
  aspectRatio     CfAspectRatio      @default(portrait)
  videoUrl        String?            @map("video_url")
  thumbnailUrl    String?            @map("thumbnail_url")
  status          CfGenerationStatus @default(pending)
  errorMessage    String?            @map("error_message")
  createdAt       DateTime           @default(now())

  dossier     CfProductDossier  @relation(fields: [dossierId], references: [id], onDelete: Cascade)
  sourceImage CfGeneratedImage? @relation(fields: [sourceImageId], references: [id], onDelete: SetNull)

  @@index([dossierId], map: "idx_cf_videos_dossier")
  @@index([type], map: "idx_cf_videos_type")
  @@map("cf_generated_videos")
}

// CF-004: Scripts (5 awareness levels)
model CfScript {
  id                       String   @id @default(uuid())
  dossierId                String   @map("dossier_id")
  awarenessLevel           Int      @map("awareness_level")
  marketSophistication     Int      @default(3) @map("market_sophistication")
  hook                     String
  body                     String
  cta                      String
  fullScript               String   @map("full_script")
  wordCount                Int?     @map("word_count")
  estimatedDurationSeconds Int?     @map("estimated_duration_seconds")
  promptUsed               String?  @map("prompt_used")
  model                    String   @default("claude-sonnet-4")
  performanceScore         Float?   @map("performance_score")
  createdAt                DateTime @default(now())

  dossier          CfProductDossier     @relation(fields: [dossierId], references: [id], onDelete: Cascade)
  assembledContent CfAssembledContent[]

  @@index([dossierId], map: "idx_cf_scripts_dossier")
  @@index([awarenessLevel], map: "idx_cf_scripts_awareness")
  @@map("cf_scripts")
}

// CF-005: Assembled Content
model CfAssembledContent {
  id             String            @id @default(uuid())
  dossierId      String            @map("dossier_id")
  scriptId       String?           @map("script_id")
  videoIds       Json              @default("[]") @map("video_ids")
  imageIds       Json              @default("[]") @map("image_ids")
  title          String?
  caption        String?
  hashtags       Json              @default("[]")
  finalVideoUrl  String?           @map("final_video_url")
  thumbnailUrl   String?           @map("thumbnail_url")
  targetPlatform CfPlatform        @default(tiktok) @map("target_platform")
  hasDisclosure  Boolean           @default(false) @map("has_disclosure")
  disclosureType CfDisclosureType? @map("disclosure_type")
  status         CfContentStatus   @default(draft)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  dossier          CfProductDossier     @relation(fields: [dossierId], references: [id], onDelete: Cascade)
  script           CfScript?            @relation(fields: [scriptId], references: [id], onDelete: SetNull)
  publishedContent CfPublishedContent[]

  @@index([dossierId], map: "idx_cf_assembled_dossier")
  @@index([status], map: "idx_cf_assembled_status")
  @@map("cf_assembled_content")
}

// CF-006: Published Content
model CfPublishedContent {
  id                 String          @id @default(uuid())
  contentId          String          @map("content_id")
  platform           CfPlatform
  platformPostId     String?         @map("platform_post_id")
  postUrl            String?         @map("post_url")
  promoted           Boolean         @default(false)
  promoteBudgetCents Int?            @map("promote_budget_cents")
  promoteStartAt     DateTime?       @map("promote_start_at")
  promoteEndAt       DateTime?       @map("promote_end_at")
  status             CfPublishStatus @default(published)
  publishedAt        DateTime        @default(now()) @map("published_at")

  content CfAssembledContent    @relation(fields: [contentId], references: [id], onDelete: Cascade)
  metrics CfPerformanceMetric[]

  @@index([contentId], map: "idx_cf_published_content")
  @@index([platform], map: "idx_cf_published_platform")
  @@map("cf_published_content")
}

// CF-007: Performance Metrics
model CfPerformanceMetric {
  id               String   @id @default(uuid())
  publishedId      String   @map("published_id")
  date             DateTime @db.Date
  views            Int      @default(0)
  likes            Int      @default(0)
  comments         Int      @default(0)
  shares           Int      @default(0)
  saves            Int      @default(0)
  watchTimeSeconds Int?     @map("watch_time_seconds")
  avgWatchPct      Float?   @map("avg_watch_pct")
  profileVisits    Int?     @map("profile_visits")
  linkClicks       Int      @default(0) @map("link_clicks")
  addToCarts       Int      @default(0) @map("add_to_carts")
  purchases        Int      @default(0)
  purchaseValue    Float?   @map("purchase_value")
  spendCents       Int      @default(0) @map("spend_cents")
  reach            Int      @default(0)
  engagementRate   Float?   @map("engagement_rate")
  costPerView      Float?   @map("cost_per_view")
  viewsPerDollar   Float?   @map("views_per_dollar")
  syncedAt         DateTime @default(now()) @map("synced_at")

  published CfPublishedContent @relation(fields: [publishedId], references: [id], onDelete: Cascade)

  @@unique([publishedId, date])
  @@index([publishedId], map: "idx_cf_metrics_published")
  @@map("cf_performance_metrics")
}

// CF-008: Angle Tests
model CfAngleTest {
  id                    String       @id @default(uuid())
  dossierId             String       @map("dossier_id")
  name                  String
  hypothesis            String?
  awarenessLevel        Int?         @map("awareness_level")
  hookType              String?      @map("hook_type")
  visualStyle           String?      @map("visual_style")
  budgetPerVariantCents Int          @default(500) @map("budget_per_variant_cents")
  totalBudgetCents      Int?         @map("total_budget_cents")
  variantIds            Json         @default("[]") @map("variant_ids")
  status                CfTestStatus @default(draft)
  winnerId              String?      @map("winner_id")
  winnerReason          String?      @map("winner_reason")
  startedAt             DateTime?    @map("started_at")
  completedAt           DateTime?    @map("completed_at")
  createdAt             DateTime     @default(now())

  dossier CfProductDossier @relation(fields: [dossierId], references: [id], onDelete: Cascade)

  @@index([dossierId], map: "idx_cf_tests_dossier")
  @@index([status], map: "idx_cf_tests_status")
  @@map("cf_angle_tests")
}

// CF-009: Scoring Config
model CfScoringConfig {
  id                    String   @id @default(uuid())
  name                  String
  holdRateWeight        Float    @default(0.3) @map("hold_rate_weight")
  watchTimeWeight       Float    @default(0.25) @map("watch_time_weight")
  engagementWeight      Float    @default(0.2) @map("engagement_weight")
  clickRateWeight       Float    @default(0.15) @map("click_rate_weight")
  conversionWeight      Float    @default(0.1) @map("conversion_weight")
  minViewsForValid      Int      @default(100) @map("min_views_for_valid")
  minSpendCentsForValid Int      @default(300) @map("min_spend_cents_for_valid")
  isDefault             Boolean  @default(false) @map("is_default")
  createdAt             DateTime @default(now())

  @@map("cf_scoring_config")
}
