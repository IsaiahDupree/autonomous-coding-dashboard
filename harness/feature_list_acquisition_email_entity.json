[
  {"id":"AAG-121","name":"acq_email_sequences table migration","description":"Create acq_email_sequences table: contact_id, service_slug, touch_number, subject, body_text, body_html, from_email, to_email, scheduled_at, sent_at, opened_at, clicked_at, resend_id, status. Also acq_email_discoveries and acq_email_unsubscribes tables","category":"database","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-122","name":"crm_contacts email columns migration","description":"ALTER TABLE crm_contacts: ADD email text, email_verified boolean, email_source text, active_channel text DEFAULT 'dm', email_opted_out boolean DEFAULT false","category":"database","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-123","name":"ResendClient — async Resend API wrapper","description":"acquisition/email/resend_client.py: send_email(to, subject, html, text) → resend_id. get_email_status(resend_id). Handles 422 invalid address, 429 rate limit (backoff), 5xx errors. RESEND_API_KEY from env","category":"integration","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-124","name":"EmailDiscovery — LinkedIn email extractor","description":"For contacts with linkedin_url, check if email is publicly listed on their profile. Use Safari LinkedIn automation (port 3105) to navigate profile, extract email if present in contact info section","category":"agent","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-125","name":"EmailDiscovery — website email extractor","description":"If contact has website_url, scrape contact/about page for email. Look for mailto: links, text matching email regex. Parse up to 3 pages per site. User-agent: Mozilla to avoid blocks","category":"agent","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-126","name":"EmailDiscovery — pattern guesser","description":"Given display_name + company domain (from LinkedIn or website), generate email candidates: {first}@domain, {first}.{last}@domain, {f}{last}@domain. Return as unverified candidates with confidence 0.4","category":"agent","priority":2,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-127","name":"EmailDiscovery — Perplexity email search","description":"Use Perplexity API: 'What is the email address for {name} the {niche} creator?' Parse structured response. Only accept if confidence >= 0.7 in returned data. Store source='perplexity'","category":"integration","priority":2,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-128","name":"EmailVerifier — MX record + SMTP check","description":"For each candidate email: verify MX record exists for domain (DNS lookup), then do SMTP RCPT TO check without sending. Mark email_verified=true if both pass. Skip SMTP for known providers (gmail, outlook, yahoo) that block verification","category":"agent","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-129","name":"EmailDiscoveryAgent.discover() — orchestrate all sources","description":"Run sources in priority order: linkedin → website → perplexity → pattern. Stop at first verified result. Store all candidates in acq_email_discoveries with confidence scores. UPDATE crm_contacts.email with highest-confidence verified result","category":"agent","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-130","name":"EmailContextBuilder — email-specific contact brief","description":"Extend DM ContextBuilder for email format. Add: company_name, job_title (from LinkedIn). Email-appropriate copy has more space than DM. Include company website context if known","category":"agent","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-131","name":"EmailGenerator — Claude subject + body per touch","description":"acquisition/email/email_generator.py: generate(contact_brief, touch_number, service_slug) → EmailDraft(subject, body_text, body_html). Uses touch-specific prompts from PRD-027. HTML wraps plaintext in clean minimal template","category":"agent","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-132","name":"EmailValidator — spam word + quality gate","description":"Validate generated email: no spam trigger words (list of 80+ words), subject <= 65 chars, body <= 200 words, must contain personal reference, must have clear CTA. Score 0-10, reject if <7. Regenerate once if rejected","category":"agent","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-133","name":"HTML email template — clean minimal design","description":"Simple responsive HTML template: plain white, sans-serif font, 600px max width, footer with unsubscribe link + physical address. Inlined CSS. Renders correctly in Gmail, Outlook, Apple Mail","category":"integration","priority":2,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-134","name":"EmailSequenceAgent — schedule 3-touch sequence for a contact","description":"Given contact with email + service_slug: create 3 acq_email_sequences rows with scheduled_at: touch1=now, touch2=now+4days, touch3=now+8days. Only if active_channel='email' or 'both'","category":"agent","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-135","name":"EmailSender — send scheduled emails","description":"Read acq_email_sequences WHERE status='pending' AND scheduled_at<=NOW(). For each: check email daily cap, call ResendClient.send_email(), UPDATE status='sent', sent_at, resend_id. Write to crm_messages (type='email', is_outbound=true)","category":"agent","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-136","name":"Daily email cap enforcement","description":"Check acq_daily_caps WHERE action='email'. Default limit: 30/day. Increment on each send. Block batch once limit hit. Reset at midnight UTC","category":"agent","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-137","name":"Resend webhook handler — open/click/bounce/complaint events","description":"POST /api/acquisition/email/webhooks/resend: verify Resend signature, parse event type, UPDATE acq_email_sequences (opened_at, clicked_at, status). On bounce: set email_verified=false, switch channel to dm. On complaint: add to unsubscribes","category":"integration","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-138","name":"IMAP reply detection — poll inbox for replies","description":"acquisition/email/imap_watcher.py: connect to IMAP (IMAP_HOST, IMAP_USER, IMAP_PASS from env), search for replies by In-Reply-To header matching resend_id. Run every 4h. On reply: stage='replied', trigger human notification","category":"integration","priority":2,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-139","name":"ChannelCoordinator — one active channel per contact","description":"Before scheduling email sequence: check if contact has active DM sequence in progress. If so, wait until DM sequence completes or times out. If DM gets reply, cancel pending email sequence. If DM archived, activate email","category":"agent","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-140","name":"Channel preference by source platform","description":"Contact seeded from LinkedIn → prefer email. Contact from Instagram/TikTok/Twitter → prefer DM. Store in crm_contacts.active_channel. Allow manual override via API","category":"agent","priority":2,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-141","name":"Unsubscribe handler — honor opt-outs immediately","description":"Add unsubscribe link to every email footer (unique per contact URL). GET /api/acquisition/email/unsubscribe?token={jwt}: set email_opted_out=true, cancel pending sequences, INSERT acq_email_unsubscribes. Confirm with plain page: 'You have been unsubscribed'","category":"integration","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-142","name":"Unsubscribe token — JWT with contact_id","description":"Generate signed JWT (HS256, EMAIL_UNSUB_SECRET) containing contact_id. Embed in unsubscribe URL. Verify on receipt. Expire in 365 days. Never re-email contacts in acq_email_unsubscribes","category":"integration","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-143","name":"POST /api/acquisition/email/discover endpoint","description":"Discover email for a contact. Accepts contact_id and sources[] filter. Returns: email, confidence, source, verified, discovery_time_ms","category":"api","priority":2,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-144","name":"POST /api/acquisition/email/send endpoint","description":"Send pending email sequences up to limit. Accepts dry_run. Returns sent[], skipped[], failed[] with reasons","category":"api","priority":2,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-145","name":"GET /api/acquisition/email/status endpoint","description":"Email pipeline metrics: pending sequences, sent today, open rate (7-day), click rate, bounce rate, reply rate, unsubscribe rate, cap usage","category":"api","priority":2,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-146","name":"Email discovery cron — daily 7:30AM","description":"After scoring cron runs, trigger email discovery for all newly qualified contacts that have linkedin_url or website_url. Run as separate cron: acquisition_email_discovery (7:30AM daily). Gate with ENABLE_ACQUISITION","category":"orchestrator","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-147","name":"Email send cron — daily 9:30AM","description":"After DM outreach cron (9AM), send pending email sequences for email-channel contacts. acquisition_email_send (9:30AM daily)","category":"orchestrator","priority":1,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-148","name":"Email tests — unit + integration","description":"pytest: test_email_validator_rejects_spam, test_resend_client_handles_422, test_channel_coordinator_blocks_dual_outreach, test_unsubscribe_token_valid, test_bounce_switches_channel_to_dm, test_daily_cap_blocks_at_30","category":"testing","priority":2,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-149","name":"Email CLI — python3 acquisition/email_agent.py","description":"Flags: --discover (find emails for qualified contacts), --send (send pending), --status, --dry-run. Print open/click/reply stats summary","category":"setup","priority":2,"status":"pending","prd":"PRD-027"},
  {"id":"AAG-150","name":"Email performance in weekly report","description":"Add email channel section to PRD-026 weekly report: emails sent, open rate, click rate, reply rate vs DM reply rate comparison. Best subject line performers. Bounce rate alert if >5%","category":"reporting","priority":2,"status":"pending","prd":"PRD-027"},

  {"id":"AAG-151","name":"acq_entity_associations + acq_resolution_runs migration","description":"Create acq_entity_associations table (contact_id, known_platform, known_handle, found_platform, found_handle, found_url, association_type, confidence, confirmed, evidence_sources[], claude_reasoning) and acq_resolution_runs","category":"database","priority":1,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-152","name":"crm_contacts cross-platform columns migration","description":"ALTER TABLE: ADD twitter_handle, instagram_handle, tiktok_handle, linkedin_url, website_url, entity_resolved boolean, resolution_score integer. Safe: IF NOT EXISTS, no data loss","category":"database","priority":1,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-153","name":"PerplexityClient — async Perplexity API wrapper","description":"acquisition/entity/perplexity_client.py: search(query) → str. Model: llama-3.1-sonar-large-128k-online. System prompt: identity researcher. Timeout 30s. Rate limiter: max 10 req/min. PERPLEXITY_API_KEY from env","category":"integration","priority":1,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-154","name":"PerplexityClient — structured identity query templates","description":"3 query templates: (1) social profiles for handle+niche, (2) social profiles for name+platform, (3) website owner profiles. Parse response with Claude to extract structured {twitter, instagram, tiktok, linkedin, email, website} dict","category":"integration","priority":1,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-155","name":"SafariPerplexityFallback — navigate perplexity.ai via Safari","description":"If PERPLEXITY_API_KEY not set: use Safari to navigate https://www.perplexity.ai/?q={query}, wait 5s, extract .prose or main content text. Use port 7070 Safari control or direct AppleScript. Parse with Claude","category":"integration","priority":3,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-156","name":"UsernameMatchEngine — fuzzy handle similarity","description":"acquisition/entity/username_matcher.py: squish(s) removes spaces/special chars/lowercase. handle_similarity(h1, h2) → SequenceMatcher ratio. Known handle vs candidate: SAME if ratio >= 0.85. Return candidates list sorted by score","category":"agent","priority":1,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-157","name":"BioLinkExtractor — scrape profile bio URLs","description":"For a known platform profile: get bio text + bio URL from Market Research API or crm_market_research cache. Follow linktree/beacons/bio.site links to extract all URLs. Returns set of URLs and handles extracted from link pages","category":"agent","priority":1,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-158","name":"LinktreeParser — extract all links from linktree/beacons","description":"GET https://linktr.ee/{handle} or https://beacons.ai/{handle}. Parse anchor tags and data attributes. Extract: twitter, instagram, tiktok, linkedin, youtube, website links. Return as PlatformLinks dict","category":"agent","priority":2,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-159","name":"SignalCollector — gather all evidence for a contact","description":"For a contact: run PerplexitySearcher + UsernameMatchEngine + BioLinkExtractor in parallel (asyncio.gather). Merge results into CandidateSet deduped by (platform, handle). Each candidate has evidence_sources[] and raw_data dict","category":"agent","priority":1,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-160","name":"CandidateRanker — score each candidate by evidence","description":"For each candidate: score += 40 if username_similarity >= 0.85, += 30 if bio_link_overlap, += 20 if perplexity_mentions, += 10 if same niche keywords in bio. Sort candidates by total score desc. Top 3 go to Claude disambiguation","category":"agent","priority":1,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-161","name":"AIDisambiguator — Claude confirmation per candidate","description":"For each top candidate (score >= 40): call Claude with disambiguation prompt from PRD-028. Parse JSON response: same_person, confidence, reasoning. Only mark confirmed=true if confidence >= 80. Store all (including rejected) in acq_entity_associations","category":"agent","priority":1,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-162","name":"Claude disambiguation batching — up to 5 candidates per call","description":"Batch multiple candidates into single Claude call to reduce API costs. Prompt returns JSON array of results. Fallback to individual calls if batch fails. Use claude-3-haiku for disambiguation (lower cost, sufficient accuracy)","category":"agent","priority":2,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-163","name":"AssociationWriter — persist confirmed associations to DB","description":"For each confirmed association: INSERT acq_entity_associations. Then UPDATE crm_contacts: set the appropriate handle column (twitter_handle, instagram_handle, etc.) to the confirmed value. Calculate and store resolution_score","category":"agent","priority":1,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-164","name":"ResolutionScoreCalculator — 0-100 completeness score","description":"Score: email=30pts, linkedin_url=25pts, twitter_handle=15pts, instagram_handle=15pts, tiktok_handle=10pts, website_url=5pts. UPDATE crm_contacts.resolution_score + entity_resolved=true. Trigger email discovery if email not found but score>=40","category":"agent","priority":1,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-165","name":"EntityResolutionAgent.resolve() — full pipeline for one contact","description":"Run SignalCollector → CandidateRanker → AIDisambiguator → AssociationWriter → ResolutionScoreCalculator. Log to acq_resolution_runs. Return ResolutionResult with all found handles and final score","category":"agent","priority":1,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-166","name":"Batch resolver — process all unresolved contacts","description":"Read crm_contacts WHERE entity_resolved=false OR resolution_score IS NULL. Process up to 20 per run (Perplexity rate limit). asyncio.gather for parallel resolution with semaphore(3). Log batch stats","category":"agent","priority":1,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-167","name":"Auto-trigger resolution after discovery seeding","description":"In DiscoveryAgent.run(), after ContactSeeder inserts new contacts: enqueue resolution for each new contact. Use acq_resolution_queue (simple table: contact_id, priority, queued_at). Processed by resolution cron","category":"integration","priority":1,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-168","name":"False positive protection — common name guard","description":"If handle_similarity < 0.5 AND no bio link overlap AND no Perplexity mention: skip Claude disambiguation entirely. Flag contact as needs_manual_review in resolution metadata. Prevents wasting API calls on common names","category":"agent","priority":2,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-169","name":"POST /api/acquisition/entity/resolve endpoint","description":"Resolve all platforms for one contact. Accepts contact_id, sources[]. Async: returns run_id immediately, result available via GET /api/acquisition/entity/runs/{run_id}. Sync mode (wait=true) for single contacts","category":"api","priority":2,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-170","name":"POST /api/acquisition/entity/resolve-batch endpoint","description":"Queue batch resolution for contact_ids[]. Returns queued_count. Results processed by background worker. Check status via GET /api/acquisition/entity/status","category":"api","priority":2,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-171","name":"GET /api/acquisition/entity/associations endpoint","description":"List all associations for a contact. Include confirmed and unconfirmed. Show evidence_sources, confidence, claude_reasoning. Useful for human review of borderline cases","category":"api","priority":2,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-172","name":"POST /api/acquisition/entity/confirm endpoint","description":"Manually confirm or reject a candidate association. Accepts association_id, confirmed bool. On confirm: UPDATE acq_entity_associations + UPDATE crm_contacts handle column + recalculate resolution_score","category":"api","priority":2,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-173","name":"GET /api/acquisition/entity/status endpoint","description":"Resolution pipeline status: total contacts, resolved count, avg resolution_score, email discovery rate, linkedin discovery rate, unresolved queue depth","category":"api","priority":2,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-174","name":"Resolution cron — daily 6:30AM","description":"Run after discovery cron. acquisition_entity_resolution (6:30AM daily). Process up to 20 unresolved contacts from queue. Gate with ENABLE_ACQUISITION and PERPLEXITY_API_KEY existence","category":"orchestrator","priority":1,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-175","name":"Entity resolution CLI — python3 acquisition/entity_resolution_agent.py","description":"Flags: --resolve CONTACT_ID, --batch --limit N, --status, --dry-run, --show-unresolved. Print resolution results table with confidence scores and found handles","category":"setup","priority":2,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-176","name":"Resolution in weekly report","description":"Add entity resolution section to weekly report: contacts resolved this week, avg resolution score, email discovery rate, most productive research source (perplexity vs bio_link vs username_match)","category":"reporting","priority":2,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-177","name":"PerplexityClient rate limiter","description":"Token bucket: max 10 requests/minute, 500/day. Persist counter in Supabase acq_api_usage table. If at limit: queue request for next window. Log usage for cost tracking (estimated $0.005/search)","category":"agent","priority":2,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-178","name":"Entity resolution tests","description":"pytest: test_username_matcher_squish, test_bio_link_extractor_linktree, test_perplexity_client_parses_response, test_candidate_ranker_scores, test_disambiguator_confidence_gate, test_resolution_score_calculator, test_false_positive_guard","category":"testing","priority":2,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-179","name":"acq_api_usage table — track external API costs","description":"CREATE TABLE acq_api_usage: api_name (perplexity/claude/resend), request_count, estimated_cost_usd, date. INSERT on every external API call. Used by reporting for cost tracking","category":"database","priority":3,"status":"pending","prd":"PRD-028"},
  {"id":"AAG-180","name":"Cross-platform outreach optimization — use best discovered channel","description":"After entity resolution: OutreachAgent reads resolution_score and available channels. Score>=70: pick best channel by historical reply rate for that niche. Score<40: use original discovery platform. Log channel selection reasoning","category":"agent","priority":2,"status":"pending","prd":"PRD-028"}
]
