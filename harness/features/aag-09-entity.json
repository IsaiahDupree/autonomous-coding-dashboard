{"features":[
  {"id":"AAG-153","name":"PerplexityClient — async Perplexity API wrapper","description":"acquisition/entity/perplexity_client.py: search(query) → str. Model: llama-3.1-sonar-large-128k-online. System prompt: identity researcher. Timeout 30s. Rate limiter: max 10 req/min. PERPLEXITY_API_KEY from env","category":"integration","priority":1,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-154","name":"PerplexityClient — structured identity query templates","description":"3 query templates: (1) social profiles for handle+niche, (2) social profiles for name+platform, (3) website owner profiles. Parse response with Claude to extract structured {twitter, instagram, tiktok, linkedin, email, website} dict","category":"integration","priority":1,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-155","name":"SafariPerplexityFallback — navigate perplexity.ai via Safari","description":"If PERPLEXITY_API_KEY not set: use Safari to navigate https://www.perplexity.ai/?q={query}, wait 5s, extract .prose or main content text. Use port 7070 Safari control or direct AppleScript. Parse with Claude","category":"integration","priority":3,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-156","name":"UsernameMatchEngine — fuzzy handle similarity","description":"acquisition/entity/username_matcher.py: squish(s) removes spaces/special chars/lowercase. handle_similarity(h1, h2) → SequenceMatcher ratio. Known handle vs candidate: SAME if ratio >= 0.85. Return candidates list sorted by score","category":"agent","priority":1,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-157","name":"BioLinkExtractor — scrape profile bio URLs","description":"For a known platform profile: get bio text + bio URL from Market Research API or crm_market_research cache. Follow linktree/beacons/bio.site links to extract all URLs. Returns set of URLs and handles extracted from link pages","category":"agent","priority":1,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-158","name":"LinktreeParser — extract all links from linktree/beacons","description":"GET https://linktr.ee/{handle} or https://beacons.ai/{handle}. Parse anchor tags and data attributes. Extract: twitter, instagram, tiktok, linkedin, youtube, website links. Return as PlatformLinks dict","category":"agent","priority":2,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-159","name":"SignalCollector — gather all evidence for a contact","description":"For a contact: run PerplexitySearcher + UsernameMatchEngine + BioLinkExtractor in parallel (asyncio.gather). Merge results into CandidateSet deduped by (platform, handle). Each candidate has evidence_sources[] and raw_data dict","category":"agent","priority":1,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-160","name":"CandidateRanker — score each candidate by evidence","description":"For each candidate: score += 40 if username_similarity >= 0.85, += 30 if bio_link_overlap, += 20 if perplexity_mentions, += 10 if same niche keywords in bio. Sort candidates by total score desc. Top 3 go to Claude disambiguation","category":"agent","priority":1,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-161","name":"AIDisambiguator — Claude confirmation per candidate","description":"For each top candidate (score >= 40): call Claude with disambiguation prompt from PRD-028. Parse JSON response: same_person, confidence, reasoning. Only mark confirmed=true if confidence >= 80. Store all (including rejected) in acq_entity_associations","category":"agent","priority":1,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-162","name":"Claude disambiguation batching — up to 5 candidates per call","description":"Batch multiple candidates into single Claude call to reduce API costs. Prompt returns JSON array of results. Fallback to individual calls if batch fails. Use claude-3-haiku for disambiguation (lower cost, sufficient accuracy)","category":"agent","priority":2,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-163","name":"AssociationWriter — persist confirmed associations to DB","description":"For each confirmed association: INSERT acq_entity_associations. Then UPDATE crm_contacts: set the appropriate handle column (twitter_handle, instagram_handle, etc.) to the confirmed value. Calculate and store resolution_score","category":"agent","priority":1,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-164","name":"ResolutionScoreCalculator — 0-100 completeness score","description":"Score: email=30pts, linkedin_url=25pts, twitter_handle=15pts, instagram_handle=15pts, tiktok_handle=10pts, website_url=5pts. UPDATE crm_contacts.resolution_score + entity_resolved=true. Trigger email discovery if email not found but score>=40","category":"agent","priority":1,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-165","name":"EntityResolutionAgent.resolve() — full pipeline for one contact","description":"Run SignalCollector → CandidateRanker → AIDisambiguator → AssociationWriter → ResolutionScoreCalculator. Log to acq_resolution_runs. Return ResolutionResult with all found handles and final score","category":"agent","priority":1,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-166","name":"Batch resolver — process all unresolved contacts","description":"Read crm_contacts WHERE entity_resolved=false OR resolution_score IS NULL. Process up to 20 per run (Perplexity rate limit). asyncio.gather for parallel resolution with semaphore(3). Log batch stats","category":"agent","priority":1,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-167","name":"Auto-trigger resolution after discovery seeding","description":"In DiscoveryAgent.run(), after ContactSeeder inserts new contacts: enqueue resolution for each new contact. Use acq_resolution_queue (simple table: contact_id, priority, queued_at). Processed by resolution cron","category":"integration","priority":1,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-168","name":"False positive protection — common name guard","description":"If handle_similarity < 0.5 AND no bio link overlap AND no Perplexity mention: skip Claude disambiguation entirely. Flag contact as needs_manual_review in resolution metadata. Prevents wasting API calls on common names","category":"agent","priority":2,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-169","name":"POST /api/acquisition/entity/resolve endpoint","description":"Resolve all platforms for one contact. Accepts contact_id, sources[]. Async: returns run_id immediately, result available via GET /api/acquisition/entity/runs/{run_id}. Sync mode (wait=true) for single contacts","category":"api","priority":2,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-170","name":"POST /api/acquisition/entity/resolve-batch endpoint","description":"Queue batch resolution for contact_ids[]. Returns queued_count. Results processed by background worker. Check status via GET /api/acquisition/entity/status","category":"api","priority":2,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-171","name":"GET /api/acquisition/entity/associations endpoint","description":"List all associations for a contact. Include confirmed and unconfirmed. Show evidence_sources, confidence, claude_reasoning. Useful for human review of borderline cases","category":"api","priority":2,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-172","name":"POST /api/acquisition/entity/confirm endpoint","description":"Manually confirm or reject a candidate association. Accepts association_id, confirmed bool. On confirm: UPDATE acq_entity_associations + UPDATE crm_contacts handle column + recalculate resolution_score","category":"api","priority":2,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-173","name":"GET /api/acquisition/entity/status endpoint","description":"Resolution pipeline status: total contacts, resolved count, avg resolution_score, email discovery rate, linkedin discovery rate, unresolved queue depth","category":"api","priority":2,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-175","name":"Entity resolution CLI — python3 acquisition/entity_resolution_agent.py","description":"Flags: --resolve CONTACT_ID, --batch --limit N, --status, --dry-run, --show-unresolved. Print resolution results table with confidence scores and found handles","category":"setup","priority":2,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-177","name":"PerplexityClient rate limiter","description":"Token bucket: max 10 requests/minute, 500/day. Persist counter in Supabase acq_api_usage table. If at limit: queue request for next window. Log usage for cost tracking (estimated $0.005/search)","category":"agent","priority":2,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-178","name":"Entity resolution tests","description":"pytest: test_username_matcher_squish, test_bio_link_extractor_linktree, test_perplexity_client_parses_response, test_candidate_ranker_scores, test_disambiguator_confidence_gate, test_resolution_score_calculator, test_false_positive_guard","category":"testing","priority":2,"status":"completed","passes":true,"prd":"PRD-028"},
  {"id":"AAG-180","name":"Cross-platform outreach optimization — use best discovered channel","description":"After entity resolution: OutreachAgent reads resolution_score and available channels. Score>=70: pick best channel by historical reply rate for that niche. Score<40: use original discovery platform. Log channel selection reasoning","category":"agent","priority":2,"status":"completed","passes":true,"prd":"PRD-028"}
]}
