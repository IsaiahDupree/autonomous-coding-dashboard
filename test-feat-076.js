const puppeteer = require('puppeteer');

(async () => {
  let passed = 0;
  let failed = 0;
  const results = [];

  function assert(condition, message) {
    if (condition) { passed++; results.push(`  ✓ ${message}`); }
    else { failed++; results.push(`  ✗ ${message}`); }
  }

  const browser = await puppeteer.launch({ headless: true, args: ['--no-sandbox'] });
  const page = await browser.newPage();
  await page.setViewport({ width: 1280, height: 900 });

  try {
    await page.goto('http://localhost:3000', { waitUntil: 'domcontentloaded', timeout: 15000 });
    await new Promise(r => setTimeout(r, 3000));

    console.log('\n=== Basic Setup ===');
    const hasAPI = await page.evaluate(() => typeof window.prCreator === 'object');
    assert(hasAPI, 'prCreator API exists on window');

    const hasCard = await page.evaluate(() => !!document.getElementById('pr-creator-card'));
    assert(hasCard, 'PR creator card rendered');

    const hasTabs = await page.evaluate(() => document.querySelectorAll('.pr-tab').length === 3);
    assert(hasTabs, 'Three tabs exist');

    const hasStats = await page.evaluate(() => document.querySelectorAll('.pr-stat').length === 4);
    assert(hasStats, 'Four stat cards displayed');

    // === AC1: Create PR on feature complete ===
    console.log('\n=== AC1: Create PR on feature complete ===');

    const prs = await page.evaluate(() => window.prCreator.getPullRequests());
    assert(prs.length > 0, `${prs.length} pull requests`);

    const first = prs[0];
    assert(first.id !== undefined, 'PR has id');
    assert(first.number !== undefined, 'PR has number');
    assert(first.title !== undefined, 'PR has title');
    assert(first.featureId !== undefined, 'PR has featureId');
    assert(first.branch !== undefined, 'PR has branch');
    assert(first.baseBranch !== undefined, 'PR has baseBranch');
    assert(first.status !== undefined, 'PR has status');
    assert(first.description !== undefined, 'PR has description');
    assert(first.autoGenerated === true, 'PR is auto-generated');

    const validStatuses = ['open', 'merged', 'closed', 'draft'];
    const allValid = prs.every(p => validStatuses.includes(p.status));
    assert(allValid, 'All PR statuses valid');

    // Get specific PR
    const specific = await page.evaluate((id) => window.prCreator.getPullRequest(id), first.id);
    assert(specific !== null, 'Can retrieve specific PR');

    // Create PR manually
    const newPR = await page.evaluate(() => {
      return window.prCreator.createPR({
        featureId: 'feat-076',
        title: 'feat(feat-076): Implement PR auto-creation',
        description: '## Summary\nAuto-create PRs with descriptions.',
        reviewerIds: ['rev-1'],
      });
    });
    assert(newPR !== null, 'createPR returns new PR');
    assert(newPR.title.includes('feat-076'), 'PR title includes feature ID');
    assert(newPR.status === 'open', 'New PR is open');
    assert(newPR.description.includes('Summary'), 'PR has description');

    // Create PR on complete
    const completePR = await page.evaluate(() => {
      return window.prCreator.createPROnComplete('feat-099', 'This feature adds user authentication.');
    });
    assert(completePR !== null, 'createPROnComplete returns PR');
    assert(completePR.featureId === 'feat-099', 'PR references correct feature');
    assert(completePR.reviewers.length >= 1, 'Auto-assigned reviewers');

    // Stats
    const stats = await page.evaluate(() => window.prCreator.getStats());
    assert(stats.total > 0, `Total: ${stats.total}`);
    assert(stats.open >= 0, `Open: ${stats.open}`);
    assert(stats.merged >= 0, `Merged: ${stats.merged}`);

    // PR list rendered
    const prItems = await page.evaluate(() => document.querySelectorAll('.pr-item').length);
    assert(prItems > 0, `${prItems} PR items rendered`);

    // === AC2: Generate description from PRD ===
    console.log('\n=== AC2: Generate description from PRD ===');

    const desc = await page.evaluate(() => {
      return window.prCreator.generateDescriptionFromPRD('feat-076', 'Implement auto PR creation with descriptions.');
    });
    assert(desc.length > 0, 'Generated description from PRD');
    assert(desc.includes('Summary'), 'Description has Summary section');
    assert(desc.includes('feat-076'), 'Description references feature ID');
    assert(desc.includes('Test Plan'), 'Description has Test Plan section');
    assert(desc.includes('Acceptance Criteria'), 'Description has Acceptance Criteria');

    // PR descriptions contain content
    assert(first.description.includes('##'), 'PR description has markdown headings');

    // Templates
    const templates = await page.evaluate(() => window.prCreator.getTemplates());
    assert(templates.length >= 2, `${templates.length} PR templates available`);
    assert(templates[0].id !== undefined, 'Template has id');
    assert(templates[0].name !== undefined, 'Template has name');
    assert(templates[0].sections.length > 0, 'Template has sections');

    // Switch to templates tab
    await page.evaluate(() => window.prCreator.setTab('templates'));
    await new Promise(r => setTimeout(r, 300));
    const tplTabActive = await page.evaluate(() => document.querySelector('.pr-tab[data-tab="templates"]').classList.contains('active'));
    assert(tplTabActive, 'Templates tab active');

    const tplList = await page.evaluate(() => !!document.getElementById('pr-template-list'));
    assert(tplList, 'Template list rendered');

    // === AC3: Add reviewers ===
    console.log('\n=== AC3: Add reviewers ===');

    const reviewers = await page.evaluate(() => window.prCreator.getAvailableReviewers());
    assert(reviewers.length > 0, `${reviewers.length} available reviewers`);
    assert(reviewers[0].id !== undefined, 'Reviewer has id');
    assert(reviewers[0].name !== undefined, 'Reviewer has name');
    assert(reviewers[0].role !== undefined, 'Reviewer has role');

    // PR has reviewers
    assert(newPR.reviewers.length >= 1, `PR has ${newPR.reviewers.length} reviewers`);
    assert(newPR.reviewers[0].name !== undefined, 'Reviewer has name');
    assert(newPR.reviewers[0].status !== undefined, 'Reviewer has status');

    // Add reviewer
    const addResult = await page.evaluate((prId) => window.prCreator.addReviewer(prId, 'rev-3'), newPR.id);
    assert(addResult === true, 'addReviewer returns true');

    const afterAdd = await page.evaluate((id) => window.prCreator.getPullRequest(id), newPR.id);
    assert(afterAdd.reviewers.length === 2, 'Reviewer added');

    // Duplicate add fails
    const dupAdd = await page.evaluate((prId) => window.prCreator.addReviewer(prId, 'rev-3'), newPR.id);
    assert(dupAdd === false, 'Duplicate reviewer add fails');

    // Remove reviewer
    const removeResult = await page.evaluate((prId) => window.prCreator.removeReviewer(prId, 'rev-3'), newPR.id);
    assert(removeResult === true, 'removeReviewer returns true');

    const afterRemove = await page.evaluate((id) => window.prCreator.getPullRequest(id), newPR.id);
    assert(afterRemove.reviewers.length === 1, 'Reviewer removed');

    // Reviewer badges rendered
    await page.evaluate(() => window.prCreator.setTab('prs'));
    await new Promise(r => setTimeout(r, 300));
    const reviewerBadges = await page.evaluate(() => document.querySelectorAll('.pr-reviewer').length);
    assert(reviewerBadges > 0, `${reviewerBadges} reviewer badges rendered`);

    // Create form
    await page.evaluate(() => window.prCreator.setTab('create'));
    await new Promise(r => setTimeout(r, 300));
    const hasForm = await page.evaluate(() => !!document.getElementById('pr-form'));
    assert(hasForm, 'Create form rendered');

    const hasReviewerSelect = await page.$('#pr-reviewer-select');
    assert(hasReviewerSelect !== null, 'Reviewer select exists');

    // === State ===
    console.log('\n=== State ===');
    const stateObj = await page.evaluate(() => window.prCreator.getState());
    assert(stateObj.activeTab !== undefined, 'State has activeTab');
    assert(stateObj.prCount > 0, `State tracks ${stateObj.prCount} PRs`);

    const savedState = await page.evaluate(() => localStorage.getItem('pr-creator-config') !== null);
    assert(savedState, 'State persisted to localStorage');

  } catch (err) {
    console.error('Test error:', err.message);
    failed++;
    results.push(`  ✗ Test execution error: ${err.message}`);
  }

  await browser.close();

  console.log('\n=======================================================');
  console.log('feat-076: PR Auto-Creation with Descriptions - Test Results');
  console.log('=======================================================');
  results.forEach(r => console.log(r));
  console.log(`\nTotal: ${passed + failed} | Passed: ${passed} | Failed: ${failed}`);
  console.log(failed === 0 ? '\n✅ ALL TESTS PASSED' : '\n❌ SOME TESTS FAILED');
  process.exit(failed === 0 ? 0 : 1);
})();
