# PRD-043 â€” Engagement Engine Agent

**Status:** Draft  
**Priority:** P1  
**Domain:** `engagement`  
**Module:** `actp-worker/engagement_engine_agent.py`  
**Supabase Project:** ivhfuhxorppptyuofbgq  
**Safari Automation Services:** 3004 (threads), 3005 (IG), 3006 (TikTok), 3007 (Twitter)

---

## Overview

The Engagement Engine Agent automates the "comment-first" warmup strategy: before DMing a high-value prospect, it posts genuine, value-add comments on their recent content across all active platforms. It tracks comment sentiment, monitors for replies to our comments (which significantly boost contact score), sequences follow-on touches, and detects when engagement converts to a DM opportunity. It also manages reactive commenting â€” replying to comments on our own posts to build community.

---

## Goals

1. Comment on 2â€“3 posts per target prospect before any DM is sent.
2. Track all comment activity in Supabase with link back to `contact_id`.
3. Detect when a prospect replies to our comment â†’ trigger stage upgrade + DM sequence.
4. Generate AI-personalized comments (not generic) tied to the actual post content.
5. Reactive commenting: reply to inbound comments on our own posts within 4 hours.
6. Enforce comment rate limits per platform (IG: 50/day, Twitter: 100/day, TikTok: 50/day, Threads: 80/day).
7. Build "comment history" so we never repeat near-identical comments on the same account.
8. Telegram alert when a prospect replies to our comment.

---

## Architecture

```
multi_agent_dispatch.py
  â””â”€â–º engagement_engine_agent.py
        â”œâ”€â–º actp_prospect_scores   (identifies targets for warmup)
        â”œâ”€â–º crm_contacts + crm_messages (comment history)
        â”œâ”€â–º safari_command_queue   (enqueues comment actions)
        â”œâ”€â–º Comment APIs:
        â”‚     :3005/api/instagram/comments/post
        â”‚     :3007/api/twitter/comments/post
        â”‚     :3006/api/tiktok/comments/post
        â”‚     :3004/api/threads/comments/post
        â”œâ”€â–º Supabase writes: actp_engagement_log, crm_messages
        â””â”€â–º Telegram alerts (reply detected, warmup complete)
```

---

## Warmup Sequence

```
Day 0: Comment on their most-liked recent post (value-add, 1-2 sentences)
Day 2: Comment on their second post (different topic angle)
Day 4: Like + comment on a Story/Thread reply they made
Day 6: DM window opens â†’ crm_intelligence_agent queues first DM
```

Target selection: contacts with `funnel_stage = 'awareness'` and `score â‰¥ 30` who have no recent DM sent.

---

## Supabase Tables

### `actp_engagement_log` (new)
```sql
CREATE TABLE actp_engagement_log (
  id              UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  contact_id      UUID REFERENCES crm_contacts(id),
  platform        TEXT NOT NULL,
  action_type     TEXT NOT NULL,   -- comment | reply | like | reaction
  post_url        TEXT,
  comment_text    TEXT,
  comment_id      TEXT,
  replied_by_target BOOLEAN DEFAULT false,
  reply_text      TEXT,
  reply_detected_at TIMESTAMPTZ,
  warmup_day      INTEGER,         -- 0,2,4 for sequence tracking
  campaign_id     TEXT,
  status          TEXT DEFAULT 'sent',
  created_at      TIMESTAMPTZ DEFAULT now()
);
CREATE INDEX ON actp_engagement_log(contact_id, platform);
CREATE INDEX ON actp_engagement_log(platform, created_at DESC);
```

### `actp_engagement_campaigns` (new)
```sql
CREATE TABLE actp_engagement_campaigns (
  id             UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  contact_id     UUID REFERENCES crm_contacts(id),
  platform       TEXT,
  status         TEXT DEFAULT 'warmup',  -- warmup | dm_ready | converted | stalled
  warmup_start   TIMESTAMPTZ DEFAULT now(),
  comments_sent  INTEGER DEFAULT 0,
  replies_received INTEGER DEFAULT 0,
  dm_sent_at     TIMESTAMPTZ,
  converted_at   TIMESTAMPTZ,
  UNIQUE(contact_id, platform)
);
```

---

## AI Comment Generation

Comments are generated by Claude using this context:
```python
{
  "post_text": "...",
  "author_niche": "ai_automation",
  "our_offer": "safari_automation",
  "relationship_stage": "warmup_day_0",
  "avoid_generic": True,
  "max_chars": 280,
  "tone": "genuine_peer"
}
```

**Output:** A comment that references specific content in the post, adds a perspective or question, and never mentions our product/offer.

---

## CLI Interface

```bash
python3 engagement_engine_agent.py --warmup-queue         # show contacts ready for warmup
python3 engagement_engine_agent.py --run-warmup --limit 5 # comment on top 5 targets today
python3 engagement_engine_agent.py --check-replies        # scan for replies to our comments
python3 engagement_engine_agent.py --reactive             # reply to inbound comments on our posts
python3 engagement_engine_agent.py --campaigns            # status of all active campaigns
python3 engagement_engine_agent.py --history CONTACT_ID   # engagement history for a contact
python3 engagement_engine_agent.py --rate-limits          # daily comment usage per platform
python3 engagement_engine_agent.py --ready-for-dm         # contacts that completed warmup
python3 engagement_engine_agent.py --status               # summary: campaigns, comments today, replies
python3 engagement_engine_agent.py --full                 # run-warmup + check-replies + reactive
```

### Dispatch Integration
```python
AGENTS["engagement"] = {
    "warmup":  ("engagement_engine_agent.py", ["--run-warmup", "--limit", "5"]),
    "replies": ("engagement_engine_agent.py", ["--check-replies"]),
    "reactive":("engagement_engine_agent.py", ["--reactive"]),
    "status":  ("engagement_engine_agent.py", ["--status"]),
    "dm-ready":("engagement_engine_agent.py", ["--ready-for-dm"]),
    "full":    ("engagement_engine_agent.py", ["--full"]),
}
```

---

## Reply Detection Logic

Every 2 hours, pull each comment's URL and check for replies:
1. Navigate to post URL via Safari
2. Find our comment in thread
3. Check for replies from the post author
4. If reply detected: update `actp_engagement_log.replied_by_target = true`, update contact score +20, move campaign to `dm_ready`, send Telegram alert

---

## Cron Schedule

| Job | Schedule | Action |
|-----|----------|--------|
| `engagement_warmup` | Daily 10 AM | `--run-warmup --limit 10` |
| `engagement_replies` | Every 2h | `--check-replies` |
| `engagement_reactive` | Every 4h | `--reactive` |
| `engagement_dm_ready` | Daily 11 AM | `--ready-for-dm` (feeds crm_intel) |

---

## Telegram Alerts

```
ðŸ’¬ Reply Detected!
Contact: @handle (Twitter)
They replied to your comment on: "AI tools for..."
Reply: "Thanks! That's a great point about..."
Score: +20 â†’ 52 (Consideration stage)
Action: DM window now OPEN

ðŸ“Š Engagement Summary â€” Today
Comments posted: 8 (TW:3, IG:2, TK:2, TH:1)
Replies received: 2 â†’ 2 contacts upgraded
Rate limits: TW 8/100 | IG 2/50 | TK 2/50 | TH 1/80
```

---

## Acceptance Criteria

- [ ] `--warmup-queue` returns contacts with `funnel_stage='awareness'` and `score â‰¥ 30`
- [ ] `--run-warmup` posts comments via Safari services and records in `actp_engagement_log`
- [ ] `--check-replies` detects replies and updates `replied_by_target` in Supabase
- [ ] Reply detection triggers score upgrade and Telegram alert
- [ ] `--ready-for-dm` returns contacts where `warmup_day â‰¥ 2` and `comments_sent â‰¥ 2`
- [ ] Rate limits enforced: no platform exceeds daily comment max
- [ ] AI-generated comments reference actual post content (not generic)
- [ ] `--campaigns` shows all active warmup campaigns with stage and day count
- [ ] `multi_agent_dispatch.py --domain engagement --task full` runs cleanly

---

## ACD Enhancement Tasks

1. Implement `engagement_engine_agent.py` with all CLI flags
2. Create Supabase migrations for `actp_engagement_log`, `actp_engagement_campaigns`
3. Implement AI comment generation with Claude, parameterized by post content + niche
4. Build reply detection logic using Safari navigation per-comment
5. Implement reactive commenting for inbound comments on our own posts
6. Add campaign state machine: warmup â†’ dm_ready â†’ converted
7. Wire `--ready-for-dm` output into `crm_intelligence_agent` DM queue
8. Send Telegram alert on reply detection with contact context
